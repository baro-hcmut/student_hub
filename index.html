<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Góc Học Tập của Sinh Viên</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Tải thư viện Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Cài đặt cơ bản & Thanh cuộn --- */
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Nền tối hơn slate-900 */
            color: #cbd5e1; /* slate-300 */
            background: linear-gradient(to bottom right, #1e293b, #0f172a); /* Nền gradient nhẹ */
            overflow-x: hidden; /* Ngăn cuộn ngang không mong muốn */
            min-height: 100vh; /* Đảm bảo gradient full height */
        }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; border-radius: 3px;} /* slate-800 */
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; } /* slate-600 */
        ::-webkit-scrollbar-thumb:hover { background: #64748b; } /* slate-500 */

        /* --- Giao diện chung --- */
        .sidebar { background-color: #1e293b; /* slate-800 */ border-right-color: #334155; /* slate-700 */}
        .card {
            background-color: #1e293b; /* slate-800 */
            border: 1px solid #334155; /* slate-700 */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Shadow nhẹ */
            border-radius: 0.75rem; /* Bo góc lớn hơn */
        }
        .card:hover {
            border-color: #6366f1; /* indigo-500 */
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.2); /* Shadow sáng hơn khi hover */
        }
        .nav-link { border-radius: 0.5rem; /* Rounded corners for nav links */ transition: background-color 0.15s, color 0.15s; }
        .nav-link.active {
            background-color: #4338ca; /* indigo-700 */
            color: #fff;
            font-weight: 600;
        }
        .nav-link:not(.active):hover {
             background-color: #334155; /* slate-700 */
             color: #f1f5f9; /* slate-100 */
        }
        
        /* --- Checkbox tùy chỉnh --- */
        .custom-checkbox {
            -webkit-appearance: none; appearance: none;
            background-color: #334155; border: 1px solid #475569;
            width: 1.25rem; height: 1.25rem; border-radius: 0.375rem;
            cursor: pointer; display: inline-block; position: relative;
            transition: all 0.15s ease-in-out; flex-shrink: 0;
        }
        .custom-checkbox:checked { background-color: #6366f1; border-color: #6366f1; }
        .custom-checkbox:checked::after {
            content: ''; position: absolute; left: 6px; top: 2px;
            width: 5px; height: 10px; border: solid white;
            border-width: 0 3px 3px 0; transform: rotate(45deg);
        }
        .custom-checkbox:focus {
            outline: none; box-shadow: 0 0 0 2px #0f172a, 0 0 0 4px #6366f1;
        }
        .task-item.completed span, .goal-item.completed span, .project-task.completed span {
            text-decoration: line-through; color: #64748b; /* slate-500 */
        }

        /* --- Các thành phần khác --- */
        .timetable-table td { height: 70px; min-width: 90px; cursor: pointer; transition: background-color: 0.15s ease-in-out; border-color: #334155;}
        .timetable-table th { border-color: #475569;}
        .timetable-table .time-slot-cell { cursor: default; }
        .timetable-table td:not(.time-slot-cell):hover { background-color: #334155; }
        .timetable-entry { font-size: 0.8rem; padding: 4px; border-radius: 4px; background-color: #6366f1; color: white; overflow: hidden; text-overflow: ellipsis; }
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.8); backdrop-filter: blur(5px); } /* Nền modal đậm hơn */
        .habit-day { width: 30px; height: 30px; border: 2px solid #475569; }
        .habit-day.completed { background-color: #22c55e; border-color: #16a34a; }
        .habit-day.today { border-color: #3b82f6; cursor: pointer; }
        .progress-bar { background-color: #334155; height: 0.6rem; } /* Tăng chiều cao nhẹ */
        .progress-bar-inner { background-color: #6366f1; transition: width 0.3s ease-out; } /* Thêm transition cho XP bar */
        .countdown-digits { background-color: #0f172a; padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-size: 2rem; line-height: 2.25rem; font-weight: 700; color: white; }
        .gpa-input, .auth-input, .app-input, .app-select {
            background-color: #334155; border: 1px solid #475569; color: #cbd5e1; border-radius: 0.5rem; padding: 0.75rem 1rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            -webkit-appearance: none; appearance: none; /* Tắt giao diện mặc định của select */
        }
        .app-select { /* Chỉ áp dụng mũi tên cho select */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1em 1em;
            padding-right: 2.5rem; /* Thêm padding cho mũi tên */
        }
        .app-input[type="time"] { padding-right: 1rem; background-image: none; } /* Sửa padding cho input time */
        .auth-input:focus, .app-input:focus, .app-select:focus {
            outline: none; border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }
        .btn {
            padding: 0.625rem 1.25rem; border-radius: 0.5rem; font-semibold;
            transition: all 0.1s ease-in-out; /* Nhanh nhất */
            transform: scale(1);
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            cursor: pointer;
        }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .btn-primary {
            background-color: #6366f1; color: white;
            box-shadow: 0 4px 10px -4px rgba(99, 102, 241, 0.5);
        }
        .btn-primary:hover { background-color: #4f46e5; transform: translateY(-1px); }
        .btn-primary:active { transform: scale(0.97); box-shadow: 0 1px 3px -2px rgba(99, 102, 241, 0.7); } /* Hiệu ứng nhấn nút tinh tế hơn */
        .btn-secondary { background-color: #334155; color: #cbd5e1; }
        .btn-secondary:hover { background-color: #475569; }
        .btn-secondary:active { transform: scale(0.97); }
        .btn-danger { background-color: #ef4444; color: white; } /* red-500 */
        .btn-danger:hover { background-color: #dc2626; } /* red-600 */
        .btn-danger:active { transform: scale(0.97); }
        .icon-btn { padding: 0.5rem; } /* Nút chỉ chứa icon */
        .icon-btn i { width: 1.125rem; height: 1.125rem; }
        
        .section-title {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700;
            color: #f1f5f9; /* slate-100 */
            margin-bottom: 1.5rem; /* mb-6 */
        }
        
        /* Cải thiện hiển thị danh sách */
        .list-item {
             display: flex;
             align-items: center;
             justify-content: space-between;
             padding: 0.75rem; /* p-3 */
             border-radius: 0.5rem; /* rounded-lg */
             border: 1px solid #334155; /* border-slate-700 */
             transition: background-color 0.15s ease-in-out; /* Nhanh hơn */
             min-height: 54px; /* Đảm bảo chiều cao tối thiểu */
        }
         .list-item:hover {
              background-color: rgba(51, 65, 85, 0.4); /* bg-slate-800/40 */
         }
         .list-item-content {
             display: flex;
             align-items: center;
             gap: 1rem; /* gap-4 */
             min-width: 0; /* Cho phép text wrap */
         }
         .list-item-content-stacked { /* Dành cho task/resource có tag */
             display: flex;
             align-items: flex-start; /* Align top */
             gap: 1rem; /* gap-4 */
             min-width: 0;
         }
         .list-item-text {
             color: #f1f5f9; /* text-white */
             word-break: break-word; /* Wrap text */
             line-height: 1.5; /* Cải thiện đọc */
         }
         .list-item-actions {
             flex-shrink: 0;
             margin-left: 0.75rem; /* ml-3 */
         }
         .delete-btn { /* Style chung cho nút xóa */
            color: #64748b; /* slate-500 */
            transition: color 0.15s ease-in-out;
            background: none; /* Ensure no background interference */
            border: none;
            padding: 0.25rem; /* Add some padding for easier clicking */
         }
         .delete-btn:hover {
            color: #ef4444; /* red-500 */
         }
         
         /* Cải thiện dashboard cards */
         .summary-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 110px; /* Chiều cao cố định */
         }
         .summary-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Align icon top */
         }
         .summary-card-title {
            color: #94a3b8; /* slate-400 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500;
            line-height: 1.25; /* leading-tight */
         }
         .summary-card-value {
             font-size: 1.875rem; /* text-3xl */
             font-weight: 700;
             color: #f1f5f9; /* slate-100 */
             margin-top: 0.5rem; /* mt-2 */
             line-height: 1; /* Ensure tight line height for numbers */
         }
         .summary-card-icon {
            padding: 0.5rem; /* p-2 */
            border-radius: 0.5rem; /* rounded-lg */
            flex-shrink: 0;
         }
         
         /* Styles for linked items tags */
         .link-tag {
             font-size: 0.75rem; /* text-xs */
             padding: 0.125rem 0.5rem; /* px-2 py-0.5 */
             border-radius: 9999px; /* rounded-full */
             font-weight: 500;
             display: inline-block; /* Đảm bảo tag hoạt động tốt */
         }
         .project-link-tag {
             background-color: #3730a3; /* indigo-800 */
             color: #c7d2fe; /* indigo-200 */
         }
         .subject-link-tag {
             background-color: #065f46; /* emerald-800 */
             color: #a7f3d0; /* emerald-200 */
         }

         /* Badge Styles */
         .badge-card {
             display: flex;
             flex-direction: column;
             align-items: center;
             justify-content: center;
             text-align: center;
             padding: 1rem;
             border-radius: 0.75rem;
             background-color: #334155; /* slate-700 */
             border: 1px solid #475569; /* slate-600 */
         }
         .badge-card.unlocked {
             background-color: #1e293b; /* slate-800 */
             border-color: #6366f1; /* indigo-500 */
         }
         .badge-icon {
             width: 3rem; /* w-12 */
             height: 3rem; /* h-12 */
             padding: 0.5rem; /* p-2 */
             border-radius: 9999px; /* rounded-full */
             margin-bottom: 0.75rem; /* mb-3 */
             display: flex;
             align-items: center;
             justify-content: center;
         }
         .badge-icon.unlocked {
             background-color: #4f46e5; /* indigo-600 */
             color: #e0e7ff; /* indigo-100 */
         }
         .badge-icon.locked {
             background-color: #475569; /* slate-600 */
             color: #94a3b8; /* slate-400 */
         }
         .badge-card.unlocked .badge-title {
             color: #f1f5f9; /* slate-100 */
             font-weight: 600;
         }
         .badge-card.locked {
             opacity: 0.6;
         }
         .badge-title {
             font-size: 0.875rem; /* text-sm */
             font-weight: 500;
             color: #94a3b8; /* slate-400 */
             margin-bottom: 0.25rem; /* mb-1 */
         }
         .badge-desc {
             font-size: 0.75rem; /* text-xs */
             color: #94a3b8; /* slate-400 */
         }
         
         /* Toast Notification */
        .toast-notification {
            position: fixed;
            bottom: 1.5rem; /* bottom-6 */
            right: 1.5rem; /* right-6 */
            background-color: #1e293b; /* slate-800 */
            border: 1px solid #334155; /* slate-700 */
            border-left: 4px solid #6366f1; /* border-l-4 border-indigo-500 */
            padding: 1rem; /* p-4 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 0.75rem; /* gap-3 */
            z-index: 100;
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
        }
        .toast-notification.show {
            transform: translateX(0);
        }
        .toast-notification.success {
            border-left-color: #22c55e; /* green-500 */
        }
        .toast-notification.error {
            border-left-color: #ef4444; /* red-500 */
        }
    </style>
</head>
<body class="antialiased">

    <!-- Authentication Screen -->
    <div id="auth-screen" class="flex items-center justify-center min-h-screen bg-slate-900 px-4">
        <div class="card p-8 rounded-xl w-full max-w-sm shadow-2xl">
            <div class="text-center mb-6">
                <i data-lucide="brain-circuit" class="mx-auto h-12 w-12 text-indigo-400"></i>
                <h2 id="auth-title" class="mt-4 text-2xl font-bold text-white">Đăng nhập vào Student Hub</h2>
                <p class="text-slate-400">Sử dụng tài khoản của bạn để tiếp tục</p>
            </div>
            <form id="auth-form" class="space-y-4">
                 <div id="name-field-container" class="hidden">
                    <input type="text" id="name-input" placeholder="Họ và tên" class="auth-input w-full" required>
                </div>
                <div>
                    <input type="email" id="email-input" placeholder="Email" class="auth-input w-full" required>
                </div>
                <div>
                    <input type="password" id="password-input" placeholder="Mật khẩu (ít nhất 6 ký tự)" class="auth-input w-full" required>
                </div>
                <div id="auth-error" class="text-red-400 text-sm text-center hidden"></div>
                <button type="submit" id="auth-submit-btn" class="w-full btn btn-primary">Đăng nhập</button>
            </form>
            <p class="mt-6 text-center text-sm text-slate-400">
                <span id="auth-toggle-text">Chưa có tài khoản?</span>
                <a href="#" id="auth-toggle-link" class="font-semibold text-indigo-400 hover:text-indigo-300">Đăng ký ngay</a>
            </p>
        </div>
    </div>
    
    <!-- Main Application -->
    <div id="app-container" class="hidden">
        <!-- Overlay for mobile sidebar -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-30 hidden lg:hidden transition-opacity duration-200 opacity-0"></div>
        
        <div class="relative min-h-screen lg:flex">
            <!-- Mobile Menu Button -->
            <button id="menu-toggle" class="lg:hidden fixed top-4 left-4 z-50 p-2 bg-indigo-600/80 text-white rounded-full shadow-lg backdrop-blur-sm">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            
            <!-- Sidebar -->
            <aside id="sidebar" class="sidebar w-64 flex-shrink-0 flex flex-col p-4 border-r fixed inset-y-0 left-0 z-40 transform -translate-x-full transition-transform duration-200 ease-in-out lg:relative lg:translate-x-0"> 
                <div class="flex items-center gap-3 mb-8">
                    <div class="bg-indigo-600 p-2 rounded-lg">
                        <i data-lucide="brain-circuit" class="text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold text-white">Student Hub</h1>
                </div>
                <nav class="flex flex-col gap-1 flex-grow"> 
                    <a href="#" data-target="dashboard" class="nav-link active flex items-center gap-3 px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Bảng điều khiển
                    </a>
                    <a href="#" data-target="analytics" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="pie-chart" class="w-5 h-5"></i> Phân tích
                    </a>
                    <a href="#" data-target="badges" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="award" class="w-5 h-5"></i> Huy hiệu
                    </a>
                    <a href="#" data-target="timetable" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="calendar-days" class="w-5 h-5"></i> Thời khóa biểu
                    </a>
                    <a href="#" data-target="gpa-calculator" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="calculator" class="w-5 h-5"></i> Máy tính GPA
                    </a>
                    <a href="#" data-target="events" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="calendar-clock" class="w-5 h-5"></i> Lịch thi & Hạn chót
                    </a>
                    <a href="#" data-target="projects" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="kanban-square" class="w-5 h-5"></i> Dự án & Bài tập lớn
                    </a>
                    <a href="#" data-target="tasks" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="check-square" class="w-5 h-5"></i> Công việc hàng ngày
                    </a>
                    <a href="#" data-target="habits" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="repeat" class="w-5 h-5"></i> Theo dõi Thói quen
                    </a>
                    <a href="#" data-target="goals" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="target" class="w-5 h-5"></i> Mục tiêu
                    </a>
                    <a href="#" data-target="pomodoro" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="timer" class="w-5 h-5"></i> Hẹn giờ Pomodoro
                    </a>
                    <a href="#" data-target="notes" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="notebook-pen" class="w-5 h-5"></i> Ghi chú nhanh
                    </a>
                    <a href="#" data-target="resources" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="link" class="w-5 h-5"></i> Tài nguyên học tập
                    </a>
                    <a href="#" data-target="music" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg transition-colors">
                        <i data-lucide="music-4" class="w-5 h-5"></i> Nhạc tập trung
                    </a>
                </nav>
                <!-- NEW: XP & Level Bar -->
                <div class="mt-4 mb-2">
                    <div class="flex justify-between items-center mb-1 text-xs font-semibold">
                        <span class="text-indigo-300">Cấp độ: <span id="user-level">1</span></span>
                        <span class="text-slate-400"><span id="user-xp">0</span> / <span id="xp-to-next-level">100</span> XP</span>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-1.5">
                        <div id="xp-progress-bar" class="bg-indigo-500 h-1.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div class="mt-auto">
                     <div class="flex items-center justify-between gap-3 p-2 rounded-xl card">
                        <div class="flex items-center gap-3 min-w-0">
                            <img src="https://placehold.co/40x40/7c3aed/ffffff?text=User" alt="User Avatar" class="rounded-full flex-shrink-0">
                            <div class="min-w-0">
                                <p id="user-display-name" class="font-semibold text-white text-sm truncate">Tên Sinh Viên</p>
                                <p id="user-email" class="text-xs text-slate-400 truncate">email@example.com</p>
                            </div>
                        </div>
                        <button id="logout-btn" title="Đăng xuất" class="text-slate-400 hover:text-white flex-shrink-0 p-1.5 rounded-md hover:bg-slate-700">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main id="main-content" class="main-content flex-1 p-6 sm:p-8 lg:p-10 overflow-y-auto lg:ml-64"> 
                <div class="pt-16 lg:pt-0 max-w-none"> 
                    <!-- Dashboard View -->
                    <section id="dashboard" class="content-section">
                        <div class="mb-8">
                            <h2 id="welcome-heading" class="section-title">Chào mừng trở lại!</h2>
                            <p class="text-slate-400" id="current-date">Hôm nay là ngày tuyệt vời để học tập.</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                            <div class="card p-6 md:col-span-2 lg:col-span-4 xl:col-span-5 bg-gradient-to-br from-indigo-700/60 to-indigo-900/40 border-indigo-700/80">
                                <div id="upcoming-event-dashboard"></div>
                            </div>
                            
                            <div class="card p-4 summary-card">
                                <div class="summary-card-header">
                                    <p class="summary-card-title">GPA học kỳ</p>
                                    <div class="summary-card-icon bg-teal-600/20 text-teal-400"><i data-lucide="graduation-cap" class="w-5 h-5"></i></div>
                                </div>
                                <p class="summary-card-value" id="gpa-dashboard">N/A</p>
                            </div>
                             <div class="card p-4 summary-card">
                                 <div class="summary-card-header">
                                    <p class="summary-card-title">Công việc cần làm</p>
                                    <div class="summary-card-icon bg-blue-600/20 text-blue-400"><i data-lucide="list-checks" class="w-5 h-5"></i></div>
                                </div>
                                <p class="summary-card-value" id="task-count">0</p>
                            </div>
                             <div class="card p-4 summary-card">
                                 <div class="summary-card-header">
                                    <p class="summary-card-title">Thói quen hôm nay</p>
                                    <div class="summary-card-icon bg-green-600/20 text-green-400"><i data-lucide="repeat" class="w-5 h-5"></i></div>
                                </div>
                                <p class="summary-card-value" id="habit-count">0/0</p>
                            </div>
                             <div class="card p-4 summary-card">
                                 <div class="summary-card-header">
                                    <p class="summary-card-title">Dự án đang làm</p>
                                    <div class="summary-card-icon bg-orange-600/20 text-orange-400"><i data-lucide="kanban-square" class="w-5 h-5"></i></div>
                                </div>
                                <p class="summary-card-value" id="project-count">0</p>
                            </div>
                             <div class="card p-4 summary-card">
                                 <div class="summary-card-header">
                                    <p class="summary-card-title">Mục tiêu đang theo</p>
                                    <div class="summary-card-icon bg-purple-600/20 text-purple-400"><i data-lucide="target" class="w-5 h-5"></i></div>
                                </div>
                                <p class="summary-card-value" id="goal-count">0</p>
                            </div>
                            
                            <div class="card p-6 md:col-span-2 lg:col-span-2 xl:col-span-3">
                                <h3 class="font-semibold text-white mb-4 text-lg">Lớp học hôm nay</h3>
                                <ul id="today-classes-list" class="space-y-3"></ul>
                            </div>
                            
                            <div class="card p-6 flex flex-col justify-center items-center text-center lg:col-span-1 xl:col-span-1">
                                <div class="bg-yellow-600/20 text-yellow-400 p-3 rounded-lg mb-3"><i data-lucide="timer"></i></div>
                                <p class="text-slate-400 text-sm mb-1">Phiên Pomodoro</p>
                                <p class="text-4xl font-bold text-white" id="pomodoro-sessions">0</p>
                            </div>

                            <!-- NEW: Smart Suggestion Card -->
                            <div class="card p-6 flex flex-col justify-center items-center text-center lg:col-span-1 xl:col-span-1">
                                <div class="bg-yellow-400/20 text-yellow-300 p-3 rounded-lg mb-3"><i data-lucide="lightbulb"></i></div>
                                <h4 class="font-semibold text-white mb-2">Gợi ý Thông minh</h4>
                                <p id="smart-suggestion" class="italic text-slate-300 text-sm">Hãy hoàn thành 1 công việc để nhận XP!</p>
                            </div>
                        </div>
                    </section>
                    
                    <!-- NEW: Analytics Section -->
                    <section id="analytics" class="content-section hidden">
                        <h2 class="section-title">Phân tích & Báo cáo</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="card p-6 min-h-[300px]">
                                <h3 class="font-semibold text-white mb-4 text-lg">Phân bổ Pomodoro</h3>
                                <div class="relative h-64 md:h-80">
                                    <canvas id="projectPomodoroChart"></canvas>
                                </div>
                            </div>
                            <div class="card p-6 min-h-[300px]">
                                <h3 class="font-semibold text-white mb-4 text-lg">Tiến độ Thói quen (7 ngày qua)</h3>
                                <div class="relative h-64 md:h-80">
                                    <canvas id="habitCompletionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- NEW: Badges Section -->
                    <section id="badges" class="content-section hidden">
                        <h2 class="section-title">Bộ sưu tập Huy hiệu</h2>
                        <div id="badge-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                            <!-- JS will populate this -->
                        </div>
                    </section>
                    
                    <section id="timetable" class="content-section hidden">
                        <h2 class="section-title">Thời khóa biểu</h2>
                        <div class="card p-4 overflow-x-auto">
                            <table class="w-full border-collapse text-center timetable-table">
                                <thead>
                                    <tr class="border-b border-slate-700">
                                        <th class="p-2 w-32">Thời gian</th>
                                        <th class="p-2">Thứ Hai</th>
                                        <th class="p-2">Thứ Ba</th>
                                        <th class="p-2">Thứ Tư</th>
                                        <th class="p-2">Thứ Năm</th>
                                        <th class="p-2">Thứ Sáu</th>
                                        <th class="p-2 text-blue-400">Thứ Bảy</th>
                                        <th class="p-2 text-red-400">Chủ Nhật</th>
                                    </tr>
                                </thead>
                                <tbody id="timetable-body"></tbody>
                                <tfoot>
                                    <tr>
                                        <td class="pt-4" colspan="8">
                                            <button id="add-time-slot-btn" class="w-full btn btn-primary">
                                                <i data-lucide="plus" class="w-5 h-5"></i> Thêm giờ học
                                            </button>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </section>
                    
                    <section id="gpa-calculator" class="content-section hidden">
                        <h2 class="section-title">Máy tính GPA</h2>
                        <div class="flex flex-col lg:flex-row gap-6 lg:items-start">
                            <div class="card p-6 flex-grow lg:w-2/3">
                                <div class="overflow-x-auto">
                                <table class="w-full text-left min-w-[500px]">
                                    <thead>
                                        <tr class="border-b border-slate-700">
                                            <th class="p-2 w-2/4">Tên môn học</th>
                                            <th class="p-2 text-center w-28">Số tín chỉ</th>
                                            <th class="p-2 text-center w-28">Điểm (Hệ 10)</th>
                                            <th class="p-2 text-center w-16"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="gpa-subjects-list"></tbody>
                                </table>
                                </div>
                                <button id="add-gpa-subject-btn" class="w-full mt-4 btn btn-primary">
                                    <i data-lucide="plus" class="w-5 h-5"></i> Thêm môn học
                                </button>
                            </div>
                            <div class="card p-6 lg:w-1/3 flex-shrink-0 flex flex-col justify-center items-center text-center lg:sticky lg:top-10"> 
                                <div class="bg-teal-600/20 text-teal-400 p-3 rounded-lg mb-3"><i data-lucide="graduation-cap"></i></div>
                                <p class="text-slate-400 text-sm mb-1">Điểm trung bình học kỳ</p>
                                <p id="gpa-result" class="text-5xl font-bold text-white">0.00</p>
                                <p id="gpa-result-4" class="text-slate-400 text-lg mt-1">(Hệ 4: 0.00)</p>
                            </div>
                        </div>
                    </section>

                    <section id="events" class="content-section hidden">
                        <h2 class="section-title">Lịch thi & Hạn chót</h2>
                        <div class="card p-6">
                            <form id="event-form" class="flex flex-wrap gap-4 mb-6 items-end">
                                <div class="flex-grow min-w-[200px]">
                                    <label for="event-input" class="text-sm text-slate-400">Tên sự kiện</label>
                                    <input type="text" id="event-input" placeholder="VD: Thi cuối kỳ Giải tích" class="w-full mt-1 app-input" required>
                                </div>
                                <div class="flex-grow min-w-[200px]">
                                    <label for="event-date-input" class="text-sm text-slate-400">Ngày và giờ</label>
                                    <input type="datetime-local" id="event-date-input" class="w-full mt-1 app-input" required>
                                </div>
                                <button type="submit" class="btn btn-primary"><i data-lucide="plus" class="w-5 h-5"></i> Thêm</button>
                            </form>
                            <div id="event-list" class="space-y-4"></div>
                        </div>
                    </section>

                    <section id="projects" class="content-section hidden">
                        <h2 class="section-title">Dự án & Bài tập lớn</h2>
                        <div class="card p-6 mb-6">
                            <form id="project-form" class="flex flex-wrap gap-4"> <!-- Thêm flex-wrap -->
                                <input type="text" id="project-input" placeholder="Thêm dự án mới (VD: Nghiên cứu khoa học)" class="flex-grow app-input min-w-[200px]" required>
                                <button type="submit" class="btn btn-primary"><i data-lucide="plus" class="w-5 h-5"></i> Tạo dự án</button>
                            </form>
                        </div>
                        <div id="project-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                    </section>

                    <section id="tasks" class="content-section hidden">
                        <h2 class="section-title">Công việc hàng ngày</h2>
                        <div class="card p-6">
                            <form id="task-form" class="flex flex-wrap gap-4 mb-6 items-end"> 
                                <div class="flex-grow min-w-[200px]">
                                    <label for="task-input" class="text-sm text-slate-400">Công việc mới</label>
                                    <input type="text" id="task-input" placeholder="Thêm một công việc mới..." class="w-full mt-1 app-input" required>
                                </div>
                                <div class="flex-grow min-w-[150px]">
                                    <label for="task-project-link" class="text-sm text-slate-400">Gán vào dự án</label>
                                    <select id="task-project-link" class="w-full mt-1 app-select"></select> <!-- Dùng app-select -->
                                </div>
                                <button type="submit" class="btn btn-primary"><i data-lucide="plus" class="w-5 h-5"></i> Thêm</button>
                            </form>
                            <ul id="task-list" class="space-y-3"></ul>
                        </div>
                    </section>

                    <section id="habits" class="content-section hidden">
                        <h2 class="section-title">Theo dõi Thói quen</h2>
                        <div class="card p-6">
                            <form id="habit-form" class="flex flex-wrap gap-4 mb-6"> <!-- Thêm flex-wrap -->
                                <input type="text" id="habit-input" placeholder="Thêm một thói quen mới (VD: Đọc sách 30 phút)" class="flex-grow app-input min-w-[200px]" required>
                                <button type="submit" class="btn btn-primary"><i data-lucide="plus" class="w-5 h-5"></i> Thêm</button>
                            </form>
                            <div id="habit-list" class="space-y-4"></div>
                        </div>
                    </section>
                    
                    <section id="goals" class="content-section hidden">
                        <h2 class="section-title">Mục tiêu học tập</h2>
                        <div class="card p-6">
                            <form id="goal-form" class="flex flex-wrap gap-4 mb-6"> <!-- Thêm flex-wrap -->
                                <input type="text" id="goal-input" placeholder="VD: Đạt 8.0 GPA kỳ này..." class="flex-grow app-input min-w-[200px]" required>
                                <button type="submit" class="btn btn-primary"><i data-lucide="plus" class="w-5 h-5"></i> Thêm mục tiêu</button>
                            </form>
                            <ul id="goal-list" class="space-y-3"></ul>
                        </div>
                    </section>

                    <section id="pomodoro" class="content-section hidden">
                        <h2 class="section-title">Hẹn giờ Pomodoro</h2>
                        <div class="card p-8 flex flex-col items-center max-w-md mx-auto">
                            <div class="flex flex-wrap justify-center gap-2 mb-6">
                                <button id="pomodoro-btn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold transition-colors">Pomodoro (25')</button>
                                <button id="long-focus-btn" class="px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-500 text-white font-semibold transition-colors">Tập trung dài (50')</button>
                                <button id="short-break-btn" class="px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-500 text-white font-semibold transition-colors">Nghỉ ngắn (5')</button>
                                <button id="long-break-btn" class="px-4 py-2 rounded-lg bg-slate-600 hover:bg-slate-500 text-white font-semibold transition-colors">Nghỉ dài (15')</button>
                            </div>
                             <div class="w-full my-4">
                               <label for="pomodoro-link" class="text-sm text-slate-400 mb-1 block">Liên kết với công việc/dự án:</label>
                               <select id="pomodoro-link" class="app-select w-full"></select> <!-- Dùng app-select -->
                            </div>
                            <div class="text-8xl font-bold my-8 text-white" id="timer-display">25:00</div>
                            <div class="flex gap-4">
                                <button id="start-pause-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold px-8 py-3 text-lg">Bắt đầu</button>
                                <button id="reset-btn" class="btn btn-secondary icon-btn text-lg">
                                    <i data-lucide="rotate-cw" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </section>

                    <section id="notes" class="content-section hidden">
                        <h2 class="section-title">Ghi chú nhanh</h2>
                        <div class="card p-2 h-[60vh] md:h-[70vh]">
                            <textarea id="notes-textarea" class="w-full h-full bg-transparent border-none rounded-lg p-4 focus:ring-0 text-slate-300 resize-none" placeholder="Viết ghi chú của bạn ở đây..."></textarea>
                        </div>
                    </section>

                    <section id="resources" class="content-section hidden">
                        <h2 class="section-title">Tài nguyên học tập</h2>
                        <div class="card p-6">
                             <form id="resource-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 items-end">
                                <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="resource-name-input" class="text-sm text-slate-400">Tên tài nguyên</label>
                                        <input type="text" id="resource-name-input" placeholder="VD: Đề cương Giải tích" class="w-full mt-1 app-input" required>
                                    </div>
                                    <div>
                                        <label for="resource-url-input" class="text-sm text-slate-400">Đường dẫn (URL)</label>
                                        <input type="url" id="resource-url-input" placeholder="https://..." class="w-full mt-1 app-input" required>
                                    </div>
                                </div>
                                <div class="md:col-span-1">
                                    <label for="resource-subject-link" class="text-sm text-slate-400">Gán vào môn học</label>
                                    <select id="resource-subject-link" class="w-full mt-1 app-select"></select> <!-- Dùng app-select -->
                                </div>
                                <div class="md:col-span-1">
                                    <button type="submit" class="btn btn-primary w-full"><i data-lucide="plus" class="w-5 h-5"></i> Thêm tài nguyên</button>
                                </div>
                            </form>
                            <ul id="resource-list" class="space-y-3"></ul>
                        </div>
                    </section>
                    
                    <section id="music" class="content-section hidden">
                        <h2 class="section-title">Nhạc tập trung</h2>
                        <p class="text-slate-400 mb-6">Chọn một giai điệu để giúp bạn tập trung vào công việc.</p>
                        <div class="flex flex-col lg:flex-row gap-8">
                            <div class="flex-grow lg:w-2/3">
                                <div class="aspect-video">
                                <iframe id="music-player" class="rounded-xl shadow-lg w-full h-full" src="https://www.youtube.com/embed/jfKfPfyJRdk" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                                </div>
                            </div>
                            <div class="lg:w-1/3 flex-shrink-0">
                                <div id="music-selection" class="flex flex-col gap-3"></div>
                                <div class="card p-4 mt-4">
                                    <h4 class="font-semibold text-white mb-3">Thêm nhạc của bạn</h4>
                                    <form id="add-music-form" class="space-y-3">
                                        <input type="text" id="music-name-input" placeholder="Tên bài nhạc" class="w-full app-input text-sm" required>
                                        <input type="url" id="music-url-input" placeholder="Dán link YouTube vào đây" class="w-full app-input text-sm" required>
                                        <button type="submit" class="w-full btn btn-primary btn-sm">
                                            <i data-lucide="plus" class="w-4 h-4"></i> Thêm nhạc
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="schedule-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="card p-6 rounded-xl w-full max-w-md mx-auto mt-20 shadow-lg">
            <h3 class="text-xl font-bold mb-4 text-white" id="modal-title">Thêm/Sửa Lịch học</h3>
            <form id="schedule-form">
                <input type="hidden" id="modal-cell-id">
                <div class="mb-4">
                    <label for="subject-name" class="block text-sm font-medium text-slate-300 mb-1">Tên môn học</label>
                    <input type="text" id="subject-name" class="w-full app-input" required>
                </div>
                <div class="mb-6">
                    <label for="subject-room" class="block text-sm font-medium text-slate-300 mb-1">Phòng/Địa điểm</label>
                    <input type="text" id="subject-room" class="w-full app-input">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="delete-schedule-btn" class="btn btn-danger">Xóa</button>
                    <button type="button" id="close-schedule-modal-btn" class="btn btn-secondary">Hủy</button>
                    <button type="submit" class="btn btn-primary">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-time-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="card p-6 rounded-xl w-full max-w-sm mx-auto mt-20 shadow-lg">
            <h3 class="text-xl font-bold mb-4 text-white">Thêm khung giờ mới</h3>
            <form id="add-time-form">
                <div class="mb-4">
                    <label for="new-time-input" class="block text-sm font-medium text-slate-300 mb-1">Thời gian (HH:MM)</label>
                    <input type="time" id="new-time-input" class="w-full app-input" required>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="close-add-time-modal-btn" class="btn btn-secondary">Hủy</button>
                    <button type="submit" class="btn btn-primary">Thêm</button>
                </div>
            </form>
        </div>
    </div>
    
     <div id="confirm-delete-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="card p-6 rounded-xl w-full max-w-sm mx-auto mt-20 shadow-lg">
            <h3 class="text-xl font-bold mb-2 text-white">Xác nhận xóa</h3>
            <p id="confirm-delete-message" class="text-slate-300 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancel-delete-btn" class="btn btn-secondary">Hủy</button>
                <button type="button" id="confirm-delete-btn" class="btn btn-danger">Xóa</button>
            </div>
        </div>
    </div>

    <!-- NEW: Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-[100] space-y-3"></div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // IMPORTANT: Khôi phục lại config của bạn
        const firebaseConfig = {
            apiKey: "AIzaSyAjV_5NxKcUr4sI_8hdOapmJNMtpaJqrBU",
            authDomain: "student-hub-f41cd.firebaseapp.com",
            projectId: "student-hub-f41cd",
            storageBucket: "student-hub-f41cd.firebasestorage.app",
            messagingSenderId: "31755638843",
            appId: "1:31755638843:web:2b58ced03ed7f49dcde41e",
            measurementId: "G-ENYF7MZGL0"
        };

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
             console.log("Firebase Initialized Successfully");

             // Global state and variables (moved outside DOMContentLoaded)
            let state = {};
            let dataUnsubscribe = null;
            let currentUserId = null;

            // NEW: Badge Definitions
            const allBadges = {
                'first_task': { name: 'Người Bắt Đầu', desc: 'Hoàn thành công việc đầu tiên', icon: 'check-circle' },
                'first_pomo': { name: 'Tập Trung', desc: 'Hoàn thành phiên Pomodoro đầu tiên', icon: 'timer' },
                'ten_pomos': { name: 'Chiến Binh Pomo', desc: 'Hoàn thành 10 phiên Pomodoro', icon: 'zap' },
                'first_project': { name: 'Nhà Kiến Tạo', desc: 'Tạo dự án đầu tiên', icon: 'kanban-square' },
                'first_habit': { name: 'Kỷ Luật Thép', desc: 'Duy trì thói quen 3 ngày', icon: 'repeat' },
                'first_gpa': { name: 'Học Giả', desc: 'Nhập điểm GPA lần đầu', icon: 'graduation-cap' }
            };

            const defaultState = {
                displayName: "Sinh Viên",
                level: 1, // NEW
                xp: 0, // NEW
                unlockedBadges: [], // NEW
                tasks: [], // { id, text, completed, projectId, pomodoroCount }
                goals: [], // { id, text, completed }
                habits: [], // { id, name, completedDates }
                resources: [], // { id, name, url, subjectName }
                projects: [], // { id, name, tasks: [ {id, text, completed} ], pomodoroCount }
                events: [], // { id, name, date }
                gpaSubjects: [], // { id, name, credits, score }
                userMusic: [], // { name, videoId, icon, isCustom }
                currentMusicId: 'jfKfPfyJRdk', 
                pomodoroSessions: 0, // Global count
                notes: '',
                schedule: {},
                timeSlots: ['07:00', '08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00']
            };
            
            // Define default music options globally
            const defaultMusicOptionsGlobal = [
                    { name: 'Lofi Hip Hop Radio', videoId: 'jfKfPfyJRdk', icon: 'music-2', isCustom: false },
                    { name: 'Âm thanh Quán Cà phê', videoId: 'irx_pvg-i-4', icon: 'coffee', isCustom: false },
                    { name: 'Piano Thư giãn', videoId: 'r_i4H8w_2Qc', icon: 'piano', isCustom: false },
                    { name: 'Tiếng Mưa Tự nhiên', videoId: 'q76bMs-mupk', icon: 'cloud-rain', isCustom: false }
                ];

            // --- UI Element declarations ---
            let authScreen, appContainer, logoutBtn, authForm, emailInput, passwordInput, nameInput, authError, userEmailEl, userDisplayNameEl, welcomeHeading;
            let isLoginMode = true; // Default to login mode
            let nameFieldContainer, authSubmitBtn, authToggleText, authToggleLink, authTitle;
            let currentDateEl, taskCountEl, habitCountEl, projectCountEl, goalCountEl, gpaDashboardEl, todayClassesList, upcomingEventDashboard;
            let navLinks, contentSections;
            let timetableBody, scheduleModal, closeScheduleModalBtn, scheduleForm, modalCellId, subjectNameInput, subjectRoomInput, deleteScheduleBtn, addTimeSlotBtn, addTimeModal, addTimeForm, newTimeInput, closeAddTimeModalBtn, confirmDeleteModal, confirmDeleteMessage, confirmDeleteBtn, cancelDeleteBtn;
            let gpaSubjectsList, addGpaSubjectBtn, gpaResultEl, gpaResult4El;
            let taskForm, taskInput, taskList, taskProjectLinkSelect; // Added taskProjectLinkSelect
            let habitForm, habitInput, habitList;
            let goalForm, goalInput, goalList;
            let projectForm, projectInput, projectList;
            let eventForm, eventInput, eventDateInput, eventList;
            let timerDisplay, startPauseBtn, resetBtn, pomodoroBtn, longFocusBtn, shortBreakBtn, longBreakBtn, pomodoroSessionsEl, pomodoroLinkSelect; // Added pomodoroLinkSelect
            let notesTextarea;
            let resourceForm, resourceNameInput, resourceUrlInput, resourceSubjectLinkSelect, resourceList; // Split resourceForm inputs
            let musicPlayer, musicSelection, addMusicForm, musicNameInput, musicUrlInput;
            let timeToDeleteHolder = null;
            let menuToggle, sidebar, sidebarOverlay, mainContent; // Added mainContent
            let userLevelEl, userXPEl, xpToNextLevelEl, xpProgressBar; // NEW: XP UI
            let badgeListEl; // NEW: Badges UI
            let smartSuggestionEl; // NEW: Suggestion UI
            let toastContainer; // NEW: Toast Container
            
            // Chart instances
            let projectChartInstance = null;
            let habitChartInstance = null;

            // --- Pomodoro Globals ---
            let timer; // Interval ID
            let timeInSeconds = 25 * 60; // Default time
            let isRunning = false; // Timer state
            let currentMode = 'pomodoro'; // Current mode ('pomodoro', 'short', 'long', 'long-focus')

            // --- Function to initialize UI elements (defined globally within module) ---
             function initializeUIElements() {
                authScreen = document.getElementById('auth-screen');
                appContainer = document.getElementById('app-container');
                logoutBtn = document.getElementById('logout-btn');
                authForm = document.getElementById('auth-form');
                emailInput = document.getElementById('email-input');
                passwordInput = document.getElementById('password-input');
                nameInput = document.getElementById('name-input');
                authError = document.getElementById('auth-error');
                userEmailEl = document.getElementById('user-email');
                userDisplayNameEl = document.getElementById('user-display-name');
                welcomeHeading = document.getElementById('welcome-heading');
                nameFieldContainer = document.getElementById('name-field-container');
                authSubmitBtn = document.getElementById('auth-submit-btn');
                authToggleText = document.getElementById('auth-toggle-text');
                authToggleLink = document.getElementById('auth-toggle-link');
                authTitle = document.getElementById('auth-title');
                currentDateEl = document.getElementById('current-date');
                taskCountEl = document.getElementById('task-count');
                habitCountEl = document.getElementById('habit-count');
                projectCountEl = document.getElementById('project-count');
                goalCountEl = document.getElementById('goal-count');
                gpaDashboardEl = document.getElementById('gpa-dashboard');
                todayClassesList = document.getElementById('today-classes-list');
                upcomingEventDashboard = document.getElementById('upcoming-event-dashboard');
                navLinks = document.querySelectorAll('.nav-link');
                contentSections = document.querySelectorAll('.content-section');
                timetableBody = document.getElementById('timetable-body');
                scheduleModal = document.getElementById('schedule-modal');
                closeScheduleModalBtn = document.getElementById('close-schedule-modal-btn');
                scheduleForm = document.getElementById('schedule-form');
                modalCellId = document.getElementById('modal-cell-id');
                subjectNameInput = document.getElementById('subject-name');
                subjectRoomInput = document.getElementById('subject-room');
                deleteScheduleBtn = document.getElementById('delete-schedule-btn');
                addTimeSlotBtn = document.getElementById('add-time-slot-btn');
                addTimeModal = document.getElementById('add-time-modal');
                addTimeForm = document.getElementById('add-time-form');
                newTimeInput = document.getElementById('new-time-input');
                closeAddTimeModalBtn = document.getElementById('close-add-time-modal-btn');
                confirmDeleteModal = document.getElementById('confirm-delete-modal');
                confirmDeleteMessage = document.getElementById('confirm-delete-message');
                confirmDeleteBtn = document.getElementById('confirm-delete-btn');
                cancelDeleteBtn = document.getElementById('cancel-delete-btn');
                gpaSubjectsList = document.getElementById('gpa-subjects-list');
                addGpaSubjectBtn = document.getElementById('add-gpa-subject-btn');
                gpaResultEl = document.getElementById('gpa-result');
                gpaResult4El = document.getElementById('gpa-result-4');
                taskForm = document.getElementById('task-form');
                taskInput = document.getElementById('task-input');
                taskList = document.getElementById('task-list');
                taskProjectLinkSelect = document.getElementById('task-project-link'); // Added
                habitForm = document.getElementById('habit-form');
                habitInput = document.getElementById('habit-input');
                habitList = document.getElementById('habit-list');
                goalForm = document.getElementById('goal-form');
                goalInput = document.getElementById('goal-input');
                goalList = document.getElementById('goal-list');
                projectForm = document.getElementById('project-form');
                projectInput = document.getElementById('project-input');
                projectList = document.getElementById('project-list');
                eventForm = document.getElementById('event-form');
                eventInput = document.getElementById('event-input');
                eventDateInput = document.getElementById('event-date-input');
                eventList = document.getElementById('event-list');
                timerDisplay = document.getElementById('timer-display');
                startPauseBtn = document.getElementById('start-pause-btn');
                resetBtn = document.getElementById('reset-btn');
                pomodoroBtn = document.getElementById('pomodoro-btn');
                longFocusBtn = document.getElementById('long-focus-btn');
                shortBreakBtn = document.getElementById('short-break-btn');
                longBreakBtn = document.getElementById('long-break-btn');
                pomodoroSessionsEl = document.getElementById('pomodoro-sessions');
                pomodoroLinkSelect = document.getElementById('pomodoro-link'); // Added
                notesTextarea = document.getElementById('notes-textarea');
                resourceForm = document.getElementById('resource-form');
                resourceNameInput = document.getElementById('resource-name-input'); // Added
                resourceUrlInput = document.getElementById('resource-url-input'); // Added
                resourceSubjectLinkSelect = document.getElementById('resource-subject-link'); // Added
                resourceList = document.getElementById('resource-list');
                musicPlayer = document.getElementById('music-player');
                musicSelection = document.getElementById('music-selection');
                addMusicForm = document.getElementById('add-music-form');
                musicNameInput = document.getElementById('music-name-input');
                musicUrlInput = document.getElementById('music-url-input');
                menuToggle = document.getElementById('menu-toggle');
                sidebar = document.getElementById('sidebar');
                sidebarOverlay = document.getElementById('sidebar-overlay');
                 mainContent = document.getElementById('main-content'); // Assign main content
                 
                 // NEW: XP & Badge UI
                 userLevelEl = document.getElementById('user-level');
                 userXPEl = document.getElementById('user-xp');
                 xpToNextLevelEl = document.getElementById('xp-to-next-level');
                 xpProgressBar = document.getElementById('xp-progress-bar');
                 badgeListEl = document.getElementById('badge-list');
                 smartSuggestionEl = document.getElementById('smart-suggestion');
                 toastContainer = document.getElementById('toast-container');
            }

            // Function to close sidebar (defined globally within module scope)
            function closeSidebar() {
                if(sidebar && sidebarOverlay) {
                    sidebar.classList.add('-translate-x-full');
                    sidebarOverlay.classList.remove('opacity-100'); // Fade out overlay
                     // Use timeout to hide after transition
                     setTimeout(() => sidebarOverlay.classList.add('hidden'), 200); 
                }
            }

            // --- AUTH UI LOGIC ---
             function updateAuthUI() {
                 if (!authError || !authTitle || !nameFieldContainer || !authSubmitBtn || !authToggleText || !authToggleLink || !nameInput) return; 
                authError.classList.add('hidden');
                if (isLoginMode) {
                    authTitle.textContent = 'Đăng nhập vào Student Hub';
                    nameFieldContainer.classList.add('hidden');
                    authSubmitBtn.textContent = 'Đăng nhập';
                    authToggleText.textContent = 'Chưa có tài khoản?';
                    authToggleLink.textContent = 'Đăng ký ngay';
                    nameInput.required = false;
                } else {
                    authTitle.textContent = 'Tạo tài khoản mới';
                    nameFieldContainer.classList.remove('hidden');
                    authSubmitBtn.textContent = 'Đăng ký';
                    authToggleText.textContent = 'Đã có tài khoản?';
                    authToggleLink.textContent = 'Đăng nhập';
                    nameInput.required = true;
                }
            }
            
            function showAuthError(message) {
                if (!authError) return; 
                authError.textContent = message;
                authError.classList.remove('hidden');
            }


            // --- AUTH STATE CHANGE LISTENER ---
             onAuthStateChanged(auth, user => {
                // Ensure elements are assigned, run initialization if needed
                if(!userDisplayNameEl) {
                    initializeUIElements(); 
                    if(!userDisplayNameEl) {
                         console.error("UI Elements could not be initialized."); // Log error if still fails
                         return; 
                    }
                }

                if (user) {
                    currentUserId = user.uid;
                    userDisplayNameEl.textContent = user.displayName || 'Sinh Viên';
                    userEmailEl.textContent = user.email;
                    if(welcomeHeading) welcomeHeading.textContent = `Chào mừng trở lại, ${user.displayName || 'bạn'}!`;

                    authScreen.classList.add('hidden');
                    appContainer.classList.remove('hidden');

                    const userDocRef = doc(db, "users", currentUserId);
                    if (dataUnsubscribe) dataUnsubscribe(); // Unsubscribe from previous listener
                    
                    dataUnsubscribe = onSnapshot(userDocRef, (doc) => {
                        let needsSave = false; // Flag for data migration
                        if (doc.exists()) {
                            // Merge fetched data with default state to handle potentially missing fields
                            state = { ...defaultState, ...doc.data() }; 
                            
                            // --- Data Migration Step (Thêm XP/Level/Badges) ---
                            if (state.xp === undefined) { state.xp = 0; needsSave = true; }
                            if (state.level === undefined) { state.level = 1; needsSave = true; }
                            if (state.unlockedBadges === undefined) { state.unlockedBadges = []; needsSave = true; }
                            
                            // (Migration from previous step, ensure it runs again if needed)
                             state.tasks = (state.tasks || []).map(t => {
                                const needsUpdate = t.id === undefined || t.pomodoroCount === undefined || t.projectId === undefined;
                                if (needsUpdate) needsSave = true;
                                return { 
                                    id: t.id || Date.now() + Math.random(), 
                                    text: t.text, 
                                    completed: t.completed || false, 
                                    pomodoroCount: t.pomodoroCount || 0, 
                                    projectId: t.projectId !== undefined ? t.projectId : null 
                                };
                            });
                             state.projects = (state.projects || []).map(p => {
                                 if (typeof p === 'string') { 
                                     needsSave = true;
                                     return { id: Date.now() + Math.random(), name: p, tasks: [], pomodoroCount: 0 };
                                 }
                                const needsUpdate = p.pomodoroCount === undefined || p.id === undefined;
                                if (needsUpdate) needsSave = true;
                                return { ...p, id: p.id || Date.now() + Math.random(), pomodoroCount: p.pomodoroCount || 0 };
                            });
                             // (... other migrations for resources, gpaSubjects, etc. ...)
                             
                        } else {
                            console.log("Creating initial document for user:", currentUserId);
                            state = { ...defaultState, displayName: user.displayName || "Sinh Viên" };
                            needsSave = true; // Need to save this new doc
                        }
                        
                        if (needsSave) {
                            console.log("Migrating/Creating data structure...");
                            saveData(); // Save the migrated/new structure
                        }
                        
                        renderAll(); // Render UI with the latest state
                    }, (error) => {
                        console.error("Error fetching user data:", error);
                        showTemporaryMessage("Không thể tải dữ liệu người dùng. Vui lòng thử lại.", "error");
                        state = { ...defaultState }; 
                        renderAll(); 
                    });
                    
                } else { // User is signed out
                    currentUserId = null;
                    if (dataUnsubscribe) {
                        dataUnsubscribe();
                        dataUnsubscribe = null;
                    }
                    state = { ...defaultState }; // Reset state completely
                    authScreen.classList.remove('hidden'); 
                    appContainer.classList.add('hidden'); 
                    isLoginMode = true; // Reset to login mode
                    updateAuthUI(); // Update auth form UI
                }
            });

             // --- ASYNC DATA SAVE ---
              async function saveData() {
                if (!currentUserId) return;
                if(window.saveTimeout) clearTimeout(window.saveTimeout);
                window.saveTimeout = setTimeout(async () => {
                    const userDocRef = doc(db, "users", currentUserId);
                    try {
                        const savableState = JSON.parse(JSON.stringify(state, (key, value) => 
                             (value === undefined ? null : value)
                        ));
                        await setDoc(userDocRef, savableState);
                    } catch (error) {
                        console.error("Error saving data: ", error);
                         showTemporaryMessage("Lỗi khi lưu dữ liệu.", "error");
                    }
                }, 300); 
            }
            
            // --- Helper Functions ---
             function showTemporaryMessage(message, type = "info") {
                if (!toastContainer) return;
                console.log(`[${type.toUpperCase()}] ${message}`); 
                 const toast = document.createElement('div');
                 
                 let icon = 'info';
                 let borderColor = 'border-indigo-500';
                 if (type === 'success') { icon = 'check-circle'; borderColor = 'border-green-500'; }
                 if (type === 'error') { icon = 'alert-triangle'; borderColor = 'border-red-500'; }
                 if (type === 'badge') { icon = 'award'; borderColor = 'border-yellow-400'; }


                 toast.className = `toast-notification ${borderColor}`;
                 toast.innerHTML = `
                     <i data-lucide="${icon}" class="w-5 h-5 ${type === 'badge' ? 'text-yellow-400' : ''}"></i>
                     <span class="text-sm font-medium text-slate-200">${message}</span>
                 `;
                 
                 toastContainer.appendChild(toast);
                 lucide.createIcons(); // Create icon in toast

                 // Force reflow to enable transition
                 requestAnimationFrame(() => {
                    toast.classList.add('show');
                 });
                 setTimeout(() => {
                      toast.classList.remove('show');
                      toast.addEventListener('transitionend', () => toast.remove()); // Remove after fade out
                 }, 3000);
            }

            function getTodayDateString() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
             function convertToScale4(score10) {
                 score10 = parseFloat(score10); 
                 if (isNaN(score10)) return 0.0;
                if (score10 >= 8.5) return 4.0; if (score10 >= 8.0) return 3.5; if (score10 >= 7.0) return 3.0;
                if (score10 >= 6.5) return 2.5; if (score10 >= 5.5) return 2.0; if (score10 >= 5.0) return 1.5;
                if (score10 >= 4.0) return 1.0; return 0.0;
            }
             function getYoutubeVideoId(url) { 
                 if (!url) return null;
                let videoId = null;
                const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                const match = url.match(regex);
                if (match) { videoId = match[1]; }
                return videoId;
             }
             
             // --- NEW: Gamification Functions ---
             function getXPForNextLevel(level) {
                 return 100 + (level - 1) * 50; // Tăng 50XP mỗi cấp
             }
             
             function updateXPUI() {
                 if (!userLevelEl) return; // Đảm bảo UI đã sẵn sàng
                 const level = state.level || 1;
                 const xp = state.xp || 0;
                 const nextLevelXP = getXPForNextLevel(level);
                 
                 userLevelEl.textContent = level;
                 userXPEl.textContent = xp;
                 xpToNextLevelEl.textContent = nextLevelXP;
                 xpProgressBar.style.width = `${(xp / nextLevelXP) * 100}%`;
             }
             
             function unlockBadge(badgeId) {
                 if (!allBadges[badgeId]) return; // Huy hiệu không tồn tại
                 if (!state.unlockedBadges) state.unlockedBadges = [];
                 if (state.unlockedBadges.includes(badgeId)) return; // Đã có
                 
                 // Mở khóa
                 state.unlockedBadges.push(badgeId);
                 showTemporaryMessage(`Huy hiệu Mở khóa: ${allBadges[badgeId].name}!`, "badge");
                 saveData();
                 renderBadges(); // Cập nhật UI
             }
             
             async function addXP(amount) {
                if (!state.xp === undefined) state.xp = 0;
                if (!state.level) state.level = 1;
                
                state.xp += amount;
                
                let nextLevelXP = getXPForNextLevel(state.level);
                while (state.xp >= nextLevelXP) {
                    state.level++;
                    state.xp -= nextLevelXP;
                    showTemporaryMessage(`Thăng cấp! Bạn đã đạt Cấp độ ${state.level}!`, "success");
                    nextLevelXP = getXPForNextLevel(state.level);
                }
                
                updateXPUI();
                saveData();
             }
             
             function renderBadges() {
                 if (!badgeListEl) return;
                 badgeListEl.innerHTML = '';
                 Object.keys(allBadges).forEach(badgeId => {
                     const badge = allBadges[badgeId];
                     const isUnlocked = (state.unlockedBadges || []).includes(badgeId);
                     
                     const badgeEl = document.createElement('div');
                     badgeEl.className = `badge-card ${isUnlocked ? 'unlocked' : 'locked'}`;
                     badgeEl.innerHTML = `
                         <div class="badge-icon ${isUnlocked ? 'unlocked' : 'locked'}">
                             <i data-lucide="${badge.icon}"></i>
                         </div>
                         <h4 class="badge-title">${badge.name}</h4>
                         <p class="badge-desc">${badge.desc}</p>
                     `;
                     badgeListEl.appendChild(badgeEl);
                 });
                 lucide.createIcons();
             }
             
             // --- NEW: Smart Suggestion Function ---
             function updateSmartSuggestion() {
                 if (!smartSuggestionEl) return;
                 
                 let suggestions = [];
                 
                 // 1. Gợi ý về Hạn chót
                 const now = new Date();
                 const upcomingEvents = (state.events || [])
                                     .filter(e => new Date(e.date) > now)
                                     .sort((a, b) => new Date(a.date) - new Date(b.date));
                if (upcomingEvents.length > 0) {
                     const nextEvent = upcomingEvents[0];
                     const diff = new Date(nextEvent.date) - now;
                     const daysLeft = Math.ceil(diff / (1000 * 60 * 60 * 24));
                     if (daysLeft <= 3) {
                         suggestions.push({ priority: 10, text: `Sự kiện "${nextEvent.name}" sắp diễn ra trong ${daysLeft} ngày nữa. Đã đến lúc ôn tập!` });
                     }
                 }
                 
                 // 2. Gợi ý về Công việc
                 const incompleteTasks = (state.tasks || []).filter(t => !t.completed).length;
                 if (incompleteTasks > 5) {
                     suggestions.push({ priority: 8, text: `Bạn có ${incompleteTasks} công việc chưa hoàn thành. Hãy bắt đầu một phiên Pomodoro để giải quyết!` });
                 } else if (incompleteTasks > 0) {
                     suggestions.push({ priority: 3, text: `Bạn còn ${incompleteTasks} công việc. Cố gắng hoàn thành chúng hôm nay!` });
                 }
                 
                 // 3. Gợi ý về Thói quen
                 const todayStr = getTodayDateString();
                 const incompleteHabits = (state.habits || []).filter(h => !(h.completedDates || []).includes(todayStr)).length;
                 if (incompleteHabits > 0) {
                     suggestions.push({ priority: 5, text: `Đừng quên hoàn thành ${incompleteHabits} thói quen của bạn hôm nay nhé!` });
                 }
                 
                 // 4. Gợi ý mặc định
                 suggestions.push({ priority: 1, text: `Một ngày làm việc hiệu quả bắt đầu từ một công việc nhỏ. Hãy thêm một công việc mới!` });
                 suggestions.push({ priority: 1, text: `Hãy bắt đầu một phiên Pomodoro để tăng cường sự tập trung.` });

                 // Sắp xếp và chọn gợi ý có độ ưu tiên cao nhất
                 suggestions.sort((a, b) => b.priority - a.priority);
                 smartSuggestionEl.textContent = suggestions[0].text;
             }


            // --- RENDER FUNCTIONS ---
            function updateDashboard() { 
                if (!taskCountEl || !goalCountEl || !projectCountEl || !habitCountEl || !gpaDashboardEl) return;
                taskCountEl.textContent = (state.tasks || []).filter(t => !t.completed).length;
                goalCountEl.textContent = (state.goals || []).filter(g => !g.completed).length;
                projectCountEl.textContent = (state.projects || []).length;
                
                const todayStr = getTodayDateString();
                const habits = state.habits || [];
                const completedHabitsToday = habits.filter(h => (h.completedDates || []).includes(todayStr)).length;
                habitCountEl.textContent = `${completedHabitsToday}/${habits.length}`;

                updateTodayClasses();
                updateUpcomingEventOnDashboard();
                calculateAndDisplayGpa();
                updateSmartSuggestion(); // Cập nhật gợi ý
             }
            function updateTodayClasses() { 
                 if (!todayClassesList) return;
                todayClassesList.innerHTML = '';
                const dayMap = ['Chủ Nhật', 'Thứ Hai', 'Thứ Ba', 'Thứ Tư', 'Thứ Năm', 'Thứ Sáu', 'Thứ Bảy'];
                const today = dayMap[new Date().getDay()];
                
                const todayEntries = Object.entries(state.schedule || {}).filter(([key]) => key.startsWith(today));
                
                if (todayEntries.length === 0) {
                    todayClassesList.innerHTML = `<p class="text-slate-500 text-sm">Không có lớp học nào hôm nay.</p>`;
                    return;
                }
                
                todayEntries.sort(([keyA], [keyB]) => {
                    const timeA = keyA.split('-')[1];
                    const timeB = keyB.split('-')[1];
                    return timeA.localeCompare(timeB);
                }).forEach(([key, value]) => {
                    const time = key.split('-')[1];
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center text-sm';
                    li.innerHTML = `
                        <div>
                            <p class="font-semibold text-white">${value.subject}</p>
                            <p class="text-slate-400">${value.room || ''}</p>
                        </div>
                        <span class="font-mono bg-slate-700 text-slate-300 px-2 py-0.5 rounded-md text-xs">${time}</span>`; 
                    todayClassesList.appendChild(li);
                });
             }
            function generateTimetable() { 
                if (!timetableBody) return;
                timetableBody.innerHTML = '';
                const days = ['Thứ Hai', 'Thứ Ba', 'Thứ Tư', 'Thứ Năm', 'Thứ Sáu', 'Thứ Bảy', 'Chủ Nhật'];
                
                (state.timeSlots || defaultState.timeSlots).sort().forEach(time => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-slate-700'; 
                    const timeCell = document.createElement('td');
                    timeCell.className = 'time-slot-cell p-2 border-r border-slate-700 font-semibold text-slate-400';
                    timeCell.innerHTML = `<div class="flex items-center justify-center gap-2"><span>${time}</span><button data-time="${time}" class="delete-time-slot-btn text-slate-600 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
                    row.appendChild(timeCell);
                    days.forEach(day => {
                        const cell = document.createElement('td');
                        cell.className = 'p-1 border-r border-slate-700 align-top';
                        cell.dataset.id = `${day}-${time}`;
                        row.appendChild(cell);
                    });
                    timetableBody.appendChild(row);
                });
                lucide.createIcons();
                renderSchedule();
             }
            function renderSchedule() { 
                 if (!timetableBody) return;
                document.querySelectorAll('#timetable-body td[data-id]').forEach(cell => {
                    cell.innerHTML = '';
                    const cellId = cell.dataset.id;
                    if (state.schedule && state.schedule[cellId]) {
                        const entry = document.createElement('div');
                        entry.className = 'timetable-entry';
                        entry.innerHTML = `<p class="font-bold">${state.schedule[cellId].subject}</p><p>${state.schedule[cellId].room || ''}</p>`;
                        cell.appendChild(entry);
                    }
                });
             }
             function calculateAndDisplayGpa() { 
                 if (!gpaResultEl || !gpaDashboardEl) return;
                let totalPoints = 0, totalCredits = 0, totalPoints4 = 0;
                (state.gpaSubjects || []).forEach(subject => {
                    const credits = parseFloat(subject.credits) || 0;
                    const score = parseFloat(subject.score) || 0;
                    if (credits > 0 && score >= 0 && score <= 10) { 
                        totalCredits += credits;
                        totalPoints += score * credits;
                        totalPoints4 += convertToScale4(score) * credits;
                    }
                });
                const gpa10 = totalCredits > 0 ? (totalPoints / totalCredits) : 0;
                const gpa4 = totalCredits > 0 ? (totalPoints4 / totalCredits) : 0;
                gpaResultEl.textContent = gpa10.toFixed(2);
                gpaResult4El.textContent = `(Hệ 4: ${gpa4.toFixed(2)})`;
                gpaDashboardEl.textContent = gpa10 > 0 ? gpa10.toFixed(2) : 'N/A';
             }
            function renderGpaSubjects() { 
                 if (!gpaSubjectsList) return;
                gpaSubjectsList.innerHTML = '';
                (state.gpaSubjects || []).forEach((subject, index) => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-slate-800 last:border-b-0'; 
                    tr.innerHTML = `
                        <td class="p-2"><input type="text" class="gpa-input" data-index="${index}" data-field="name" value="${subject.name || ''}" placeholder="Tên môn học"></td>
                        <td class="p-2"><input type="number" class="gpa-input text-center" data-index="${index}" data-field="credits" value="${subject.credits || ''}" min="0" placeholder="0"></td>
                        <td class="p-2"><input type="number" class="gpa-input text-center" data-index="${index}" data-field="score" value="${subject.score || ''}" min="0" max="10" step="0.1" placeholder="0.0"></td>
                        <td class="p-2 text-center"><button class="delete-gpa-subject-btn delete-btn" data-index="${index}"><i data-lucide="trash-2" class="w-5 h-5"></i></button></td>`;
                    gpaSubjectsList.appendChild(tr);
                });
                lucide.createIcons();
                calculateAndDisplayGpa(); 
             }
             
            // --- Populate Select Functions ---
            function populatePomodoroLinks() {
                if (!pomodoroLinkSelect) return;
                pomodoroLinkSelect.innerHTML = '<option value="none">Không liên kết</option>';
                
                if (state.projects && state.projects.length > 0) {
                    const group = document.createElement('optgroup');
                    group.label = 'DỰ ÁN';
                    state.projects.forEach(proj => {
                        const option = document.createElement('option');
                        option.value = `project-${proj.id}`;
                        option.textContent = proj.name;
                        group.appendChild(option);
                    });
                    pomodoroLinkSelect.appendChild(group);
                }
                
                const incompleteTasks = (state.tasks || []).filter(t => !t.completed);
                if (incompleteTasks.length > 0) {
                     const group = document.createElement('optgroup');
                     group.label = 'CÔNG VIỆC';
                     incompleteTasks.forEach(task => {
                         const option = document.createElement('option');
                         option.value = `task-${task.id}`;
                         option.textContent = task.text;
                         group.appendChild(option);
                     });
                     pomodoroLinkSelect.appendChild(group);
                }
            }
            
            function populateTaskProjectLinks() {
                if (!taskProjectLinkSelect) return;
                taskProjectLinkSelect.innerHTML = '<option value="null">Không liên kết</option>';
                (state.projects || []).forEach(proj => {
                    const option = document.createElement('option');
                    option.value = proj.id;
                    option.textContent = proj.name;
                    taskProjectLinkSelect.appendChild(option);
                });
            }
            
            function populateResourceSubjectLinks() {
                 if (!resourceSubjectLinkSelect) return;
                resourceSubjectLinkSelect.innerHTML = '<option value="null">Không liên kết</option>';
                 const subjectNames = new Set((state.gpaSubjects || []).map(s => s.name).filter(Boolean)); // Get unique, non-empty names
                 subjectNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    resourceSubjectLinkSelect.appendChild(option);
                 });
            }
             
            function renderTasks() { 
                if (!taskList) return;
                taskList.innerHTML = '';
                if (!state.tasks || state.tasks.length === 0) taskList.innerHTML = `<p class="text-slate-500 text-center py-4">Chưa có công việc nào.</p>`; 
                else {
                    state.tasks.forEach((task, index) => {
                        const li = document.createElement('li');
                        li.className = `task-item list-item ${task.completed ? 'completed opacity-60' : ''}`; 
                        const project = task.projectId ? (state.projects || []).find(p => p.id == task.projectId) : null;
                        
                        li.innerHTML = `
                            <div class="list-item-content-stacked"> <!-- Changed to stacked for tags -->
                                 <input type="checkbox" data-index="${index}" data-id="${task.id}" class="custom-checkbox mt-1"> <!-- Added data-id -->
                                 <div>
                                     <span class="list-item-text">${task.text}</span>
                                     ${project ? `<div class="link-tag project-link-tag mt-1">${project.name}</div>` : ''}
                                 </div>
                            </div>
                            <div class="list-item-actions">
                                 <button data-index="${index}" data-id="${task.id}" class="delete-task-btn delete-btn"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                            </div>`;
                        // Manually set checkbox state because innerHTML is complex
                        const checkbox = li.querySelector('.custom-checkbox');
                        if (checkbox) checkbox.checked = task.completed;
                        
                        taskList.appendChild(li);
                    });
                }
                lucide.createIcons();
             }
            function renderHabits() { 
                if (!habitList) return;
                habitList.innerHTML = '';
                if (!state.habits || state.habits.length === 0) habitList.innerHTML = `<p class="text-slate-500 text-center py-4">Hãy bắt đầu xây dựng những thói quen tốt!</p>`;
                else {
                    const todayStr = getTodayDateString();
                    state.habits.forEach((habit, index) => {
                        const habitEl = document.createElement('div');
                        habitEl.className = 'flex flex-wrap items-center justify-between p-3 rounded-lg border border-slate-700 gap-y-2 gap-x-4'; 
                        let daysHTML = '';
                        for (let i = 6; i >= 0; i--) {
                            const date = new Date();
                            date.setDate(date.getDate() - i);
                            const dateStr = date.toISOString().split('T')[0];
                            const isCompleted = (habit.completedDates || []).includes(dateStr);
                            const isToday = (dateStr === todayStr);
                            daysHTML += `<div class="habit-day rounded-full flex items-center justify-center ${isCompleted ? 'completed' : ''} ${isToday ? 'today' : ''}" data-date="${dateStr}" data-habit-index="${index}" title="${date.toLocaleDateString('vi-VN', {weekday: 'short', day:'numeric'})}"></div>`; 
                        }
                        habitEl.innerHTML = `
                            <span class="text-white break-words mr-auto">${habit.name}</span> 
                            <div class="flex items-center gap-1 sm:gap-1.5 flex-shrink-0"> ${daysHTML} 
                               <button data-index="${index}" data-id="${habit.id}" class="delete-habit-btn delete-btn ml-2"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                             </div>`;
                        habitList.appendChild(habitEl);
                    });
                }
                lucide.createIcons();
             }
            function renderGoals() { 
                if (!goalList) return;
                goalList.innerHTML = '';
                if (!state.goals || state.goals.length === 0) goalList.innerHTML = `<p class="text-slate-500 text-center py-4">Chưa có mục tiêu nào được đặt ra.</p>`;
                else {
                    state.goals.forEach((goal, index) => {
                        const li = document.createElement('li');
                         li.className = `goal-item list-item ${goal.completed ? 'completed opacity-60' : ''}`; 
                        li.innerHTML = `
                            <div class="list-item-content">
                                 <input type="checkbox" data-index="${index}" data-id="${goal.id}" class="custom-checkbox" ${goal.completed ? 'checked' : ''}>
                                 <span class="list-item-text">${goal.text}</span>
                            </div>
                            <div class="list-item-actions">
                                 <button data-index="${index}" data-id="${goal.id}" class="delete-goal-btn delete-btn"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                            </div>`;
                         // Manually set checkbox state
                        const checkbox = li.querySelector('.custom-checkbox');
                        if (checkbox) checkbox.checked = goal.completed;
                        goalList.appendChild(li);
                    });
                }
                lucide.createIcons();
             }
            function renderProjects() { 
                if (!projectList) return;
                projectList.innerHTML = '';
                if(!state.projects || state.projects.length === 0) projectList.innerHTML = `<p class="text-slate-500 col-span-full text-center py-4">Chưa có dự án nào. Hãy bắt đầu một dự án mới!</p>`;
                else {
                    state.projects.forEach(project => {
                        const projectCard = document.createElement('div');
                        projectCard.className = 'card p-4 rounded-xl flex flex-col gap-4';
                        const projectTasks = project.tasks || []; 
                        const completedTasks = projectTasks.filter(t => t.completed).length;
                        const totalTasks = projectTasks.length;
                        const progress = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
                        let tasksHTML = '<ul class="space-y-2">';
                        projectTasks.forEach((task, taskIndex) => {
                            tasksHTML += `<li class="project-task flex items-center justify-between text-sm ${task.completed ? 'completed opacity-60' : ''}"><div class="flex items-center gap-2 min-w-0"><input type="checkbox" data-project-id="${project.id}" data-task-index="${taskIndex}" class="custom-checkbox !w-4 !h-4" ${task.completed ? 'checked' : ''}><span class="break-words">${task.text}</span></div><button data-project-id="${project.id}" data-task-index="${taskIndex}" class="delete-project-task-btn text-slate-600 hover:text-red-500 flex-shrink-0"><i data-lucide="x" class="w-4 h-4"></i></button></li>`;
                        });
                        tasksHTML += '</ul>';
                        projectCard.innerHTML = `<div><div class="flex justify-between items-start gap-2"><h3 class="font-bold text-white text-lg break-words">${project.name}</h3><button data-project-id="${project.id}" class="delete-project-btn delete-btn flex-shrink-0"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div><div class="flex items-center gap-2 mt-2 text-sm text-slate-400"><div class="progress-bar w-full rounded-full overflow-hidden"><div class="progress-bar-inner h-full rounded-full" style="width: ${progress}%;"></div></div><span>${Math.round(progress)}%</span></div></div><div>${totalTasks > 0 ? tasksHTML : '<p class="text-slate-500 text-sm">Chưa có giai đoạn nào.</p>'}</div><form class="add-project-task-form flex gap-2 mt-2"><input type="text" data-project-id="${project.id}" placeholder="Thêm giai đoạn..." class="flex-grow bg-slate-700 border border-slate-600 rounded-md px-3 py-1 text-sm focus:ring-indigo-500 focus:border-indigo-500" required><button type="submit" class="btn btn-primary btn-sm !p-1.5"><i data-lucide="plus" class="w-4 h-4"></i></button></form>`; 
                        projectList.appendChild(projectCard);
                    });
                }
                lucide.createIcons();
             }
            function renderEvents() { 
                if (!eventList) return;
                eventList.innerHTML = '';
                if(!state.events || state.events.length === 0) eventList.innerHTML = `<p class="text-slate-500 text-center py-4">Chưa có sự kiện nào được thêm.</p>`;
                else {
                    state.events.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(event => {
                        const eventEl = document.createElement('div');
                        eventEl.className = 'flex flex-wrap items-center justify-between p-4 rounded-lg border border-slate-700 gap-y-2 gap-x-4'; // Added gap-x
                        eventEl.innerHTML = `
                             <div class="min-w-0 mr-4"> 
                                 <p class="font-semibold text-white break-words">${event.name}</p>
                                 <p class="text-sm text-slate-400">${new Date(event.date).toLocaleString('vi-VN', { dateStyle: 'short', timeStyle: 'short' })}</p> <!-- Shorter date format -->
                             </div>
                             <div class="flex items-center gap-4 flex-shrink-0">
                                 <div id="countdown-${event.id}" class="text-base font-semibold text-indigo-400"></div> <!-- Smaller countdown text -->
                                 <button data-event-id="${event.id}" class="delete-event-btn delete-btn"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                             </div>`;
                        eventList.appendChild(eventEl);
                    });
                }
                lucide.createIcons();
             }
            function updateCountdowns() { 
                if (!state.events) return;
                const now = Date.now(); // Get current time once
                state.events.forEach(event => {
                    const countdownEl = document.getElementById(`countdown-${event.id}`);
                    if (countdownEl) {
                        const eventTime = new Date(event.date).getTime();
                         if (isNaN(eventTime)) { // Check for invalid date
                            countdownEl.textContent = "Lỗi ngày";
                            return;
                        }
                        const diff = eventTime - now;
                        if (diff > 0) {
                            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                            if (days > 1) { countdownEl.textContent = `${days} ngày`; } 
                            else if (days === 1) { countdownEl.textContent = `1d ${hours}h`; } 
                            else if (hours > 0) { countdownEl.textContent = `${hours}h ${minutes}m`; } 
                            else if (minutes > 0) { countdownEl.textContent = `${minutes} phút`; }
                            else { countdownEl.textContent = `< 1 phút`; } // Handle < 1 min case
                        } else {
                            countdownEl.textContent = "Đã qua";
                        }
                    }
                });
                updateUpcomingEventOnDashboard();
             }
            function updateUpcomingEventOnDashboard() { 
                 if (!upcomingEventDashboard || !state.events) return;
                const now = new Date();
                const upcomingEvents = state.events.filter(e => new Date(e.date) > now).sort((a, b) => new Date(a.date) - new Date(b.date));
                if (upcomingEvents.length > 0) {
                    const nextEvent = upcomingEvents[0];
                    const diff = new Date(nextEvent.date) - now;
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    upcomingEventDashboard.innerHTML = `<p class="text-sm text-center text-indigo-300 mb-2">SỰ KIỆN SẮP TỚI</p><h3 class="text-xl font-bold text-center text-white mb-4">${nextEvent.name}</h3><div class="flex justify-center items-center gap-2 md:gap-4 text-center"><div><span class="countdown-digits">${String(days).padStart(2, '0')}</span><span class="text-xs text-slate-400 mt-1 block">NGÀY</span></div><div><span class="countdown-digits">${String(hours).padStart(2, '0')}</span><span class="text-xs text-slate-400 mt-1 block">GIỜ</span></div><div><span class="countdown-digits">${String(minutes).padStart(2, '0')}</span><span class="text-xs text-slate-400 mt-1 block">PHÚT</span></div><div><span class="countdown-digits">${String(seconds).padStart(2, '0')}</span><span class="text-xs text-slate-400 mt-1 block">GIÂY</span></div></div>`;
                } else {
                    upcomingEventDashboard.innerHTML = `<p class="text-center text-slate-400">Không có sự kiện nào sắp tới. Hãy thêm lịch thi hoặc hạn chót mới!</p>`;
                }
             }
            function updateTimerDisplay() { 
                if (!timerDisplay) return;
                const minutes = Math.floor(timeInSeconds / 60);
                const seconds = timeInSeconds % 60;
                timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                if (isRunning) { document.title = `${timerDisplay.textContent} - Student Hub`; } 
                else { document.title = 'Góc Học Tập của Sinh Viên'; }
                if(pomodoroSessionsEl) pomodoroSessionsEl.textContent = state.pomodoroSessions || 0;
             }
            function renderNotes() { 
                if (notesTextarea) { notesTextarea.value = state.notes || ''; }
             }
            function renderResources() { 
                if (!resourceList) return;
                resourceList.innerHTML = '';
                if (!state.resources || state.resources.length === 0) resourceList.innerHTML = `<p class="text-slate-500 text-center py-4">Chưa có tài nguyên nào.</p>`;
                else {
                    state.resources.forEach((resource, index) => {
                        const li = document.createElement('li');
                        li.className = 'list-item';
                        li.innerHTML = `
                             <a href="${resource.url}" target="_blank" rel="noopener noreferrer" class="list-item-content-stacked text-indigo-400 hover:underline">
                                 <i data-lucide="link-2" class="w-5 h-5 flex-shrink-0 mt-1"></i>
                                 <div>
                                     <span class="list-item-text !text-indigo-400 truncate">${resource.name}</span>
                                     ${resource.subjectName ? `<div class="link-tag subject-link-tag mt-1">${resource.subjectName}</div>` : ''}
                                 </div>
                             </a>
                             <div class="list-item-actions">
                                <button data-index="${index}" data-id="${resource.id}" class="delete-resource-btn delete-btn"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                             </div>`;
                        resourceList.appendChild(li);
                    });
                }
                lucide.createIcons();
             }
            function renderMusicOptions() { 
                if (!musicSelection || !musicPlayer) return;
                musicSelection.innerHTML = '';
                const allMusic = [...defaultMusicOptionsGlobal, ...(state.userMusic || [])];
                
                allMusic.forEach(option => {
                    const isActive = option.videoId === state.currentMusicId;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = `music-option-btn flex items-center gap-3 w-full text-left p-3 rounded-lg border transition-colors cursor-pointer ${isActive ? 'bg-indigo-600 border-indigo-500 text-white' : 'bg-slate-700 border-slate-600 hover:bg-slate-600 text-slate-300'}`; 
                    itemDiv.dataset.videoId = option.videoId;
                    
                    let deleteButtonHTML = '';
                    if (option.isCustom) {
                        deleteButtonHTML = `<button type="button" class="delete-music-btn delete-btn ml-auto p-1 rounded-full flex-shrink-0" data-video-id="${option.videoId}"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>`; 
                    }
                    
                    itemDiv.innerHTML = `
                        <i data-lucide="${option.icon}" class="w-5 h-5 flex-shrink-0"></i>
                        <span class="font-semibold flex-grow truncate text-sm">${option.name}</span> 
                        ${deleteButtonHTML}
                    `;
                    musicSelection.appendChild(itemDiv);
                });
                
                const allIds = allMusic.map(m => m.videoId);
                if (!state.currentMusicId || !allIds.includes(state.currentMusicId)) {
                    state.currentMusicId = defaultMusicOptionsGlobal[0].videoId;
                }

                // Update iframe source only if necessary
                const currentSrc = musicPlayer.src;
                 const newSrc = `https://www.youtube.com/embed/${state.currentMusicId}`;
                 if (!currentSrc.includes(state.currentMusicId)) { 
                    musicPlayer.src = newSrc;
                 }
                lucide.createIcons();
             }
             
             // --- NEW: Analytics Render Function ---
             function renderAnalytics() {
                if (!Chart) { 
                     console.error("Chart.js is not loaded.");
                     return; 
                }
                
                Chart.defaults.color = '#cbd5e1'; // Set default text color for charts
                
                // --- Project Pomodoro Chart ---
                const projectCtx = document.getElementById('projectPomodoroChart');
                if (projectCtx) {
                    if (projectChartInstance) projectChartInstance.destroy(); // Destroy old chart
                    
                    const projectData = {};
                    let unlinkedPomos = 0;

                    // 1. Get pomodoros directly from projects
                    (state.projects || []).forEach(proj => {
                        projectData[proj.name] = (projectData[proj.name] || 0) + (proj.pomodoroCount || 0);
                    });

                    // 2. Get pomodoros from tasks and add to their projects
                    (state.tasks || []).forEach(task => {
                        if (task.pomodoroCount > 0) {
                            if (task.projectId) {
                                const project = (state.projects || []).find(p => p.id == task.projectId);
                                const projName = project ? project.name : "Dự án đã xóa";
                                projectData[projName] = (projectData[projName] || 0) + task.pomodoroCount;
                            } else {
                                unlinkedPomos += task.pomodoroCount; // Add to "unlinked"
                            }
                        }
                    });
                    
                    if(unlinkedPomos > 0) projectData["Công việc lẻ"] = unlinkedPomos;
                    
                    const labels = Object.keys(projectData);
                    const data = Object.values(projectData);
                    
                    if (labels.length > 0 && data.some(d => d > 0)) { // Check if there is data
                         projectChartInstance = new Chart(projectCtx, {
                            type: 'pie',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Số phiên Pomodoro',
                                    data: data,
                                    backgroundColor: ['#6366f1', '#22c55e', '#f97316', '#3b82f6', '#ec4899', '#f59e0b', '#10b981'],
                                    borderColor: '#1e293b',
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { position: 'bottom', labels: { color: '#cbd5e1' } } }
                            }
                        });
                    } else {
                         // Show a message if no data
                         const ctx = projectCtx.getContext('2d');
                         ctx.clearRect(0, 0, projectCtx.width, projectCtx.height);
                         ctx.fillStyle = '#94a3b8';
                         ctx.textAlign = 'center';
                         ctx.fillText("Chưa có dữ liệu Pomodoro để phân tích.", projectCtx.width / 2, projectCtx.height / 2);
                    }
                }
                
                // --- Habit Completion Chart ---
                 const habitCtx = document.getElementById('habitCompletionChart');
                 if(habitCtx) {
                     if (habitChartInstance) habitChartInstance.destroy();
                     
                     const habits = state.habits || [];
                     const labels = habits.map(h => h.name);
                     const data = habits.map(h => (h.completedDates || []).length);
                     
                     if (labels.length > 0) {
                         habitChartInstance = new Chart(habitCtx, {
                             type: 'bar',
                             data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Tổng số lần hoàn thành',
                                    data: data,
                                    backgroundColor: '#22c55e',
                                    borderColor: '#16a34a',
                                    borderWidth: 1,
                                    borderRadius: 4
                                }]
                             },
                             options: {
                                 responsive: true,
                                 maintainAspectRatio: false,
                                 indexAxis: 'y', // Horizontal bar chart
                                 scales: {
                                     x: { beginAtZero: true, grid: { color: '#334155' }, ticks: { stepSize: 1 } }, // Ensure whole numbers
                                     y: { grid: { display: false } }
                                 },
                                 plugins: { legend: { display: false } }
                             }
                         });
                     } else {
                         // Show a message if no data
                         const ctx = habitCtx.getContext('2d');
                         ctx.clearRect(0, 0, habitCtx.width, habitCtx.height);
                         ctx.fillStyle = '#94a3b8';
                         ctx.textAlign = 'center';
                         ctx.fillText("Hãy thêm thói quen để bắt đầu theo dõi.", habitCtx.width / 2, habitCtx.height / 2);
                     }
                 }
             }

            // --- FULL RENDER ALL FUNCTION ---
             function renderAll() {
                 try {
                     // Ensure state properties exist before rendering, assign defaults if needed
                     state.tasks = state.tasks || [];
                     state.goals = state.goals || [];
                     state.habits = state.habits || [];
                     state.resources = state.resources || [];
                     state.projects = state.projects || [];
                     state.events = state.events || [];
                     state.gpaSubjects = state.gpaSubjects || [];
                     state.userMusic = state.userMusic || [];
                     state.schedule = state.schedule || {};
                     state.timeSlots = Array.isArray(state.timeSlots) && state.timeSlots.length > 0 ? state.timeSlots : [...defaultState.timeSlots]; 
                     state.currentMusicId = state.currentMusicId || defaultState.currentMusicId;
                     state.pomodoroSessions = state.pomodoroSessions === undefined ? defaultState.pomodoroSessions : state.pomodoroSessions; 
                     state.notes = state.notes === undefined ? defaultState.notes : state.notes; 
                     state.displayName = state.displayName || defaultState.displayName; 
                     state.xp = state.xp || 0;
                     state.level = state.level || 1;
                     state.unlockedBadges = state.unlockedBadges || [];

                    // Populate dropdowns first
                    if (pomodoroLinkSelect) populatePomodoroLinks();
                    if (taskProjectLinkSelect) populateTaskProjectLinks();
                    if (resourceSubjectLinkSelect) populateResourceSubjectLinks();

                    // Call render functions only if corresponding elements exist
                    if (notesTextarea) renderNotes();
                    if (taskList) renderTasks();
                    if (goalList) renderGoals();
                    if (habitList) renderHabits();
                    if (resourceList) renderResources();
                    if (projectList) renderProjects();
                    if (eventList) renderEvents();
                    if (gpaSubjectsList) renderGpaSubjects();
                    if (timetableBody) generateTimetable(); // Calls renderSchedule
                    if (timerDisplay) updateTimerDisplay();
                    if (musicSelection) renderMusicOptions();
                    if (userLevelEl) updateXPUI(); // NEW
                    if (badgeListEl) renderBadges(); // NEW
                    
                    // Render analytics ONLY if the tab is active
                    const analyticsTab = document.getElementById('analytics');
                    if (analyticsTab && !analyticsTab.classList.contains('hidden')) {
                         renderAnalytics();
                    }
                    
                    if (taskCountEl) updateDashboard(); // Calls other dashboard updates (must be last)
                } catch (error) {
                    console.error("Error during renderAll:", error);
                    showTemporaryMessage("Đã xảy ra lỗi khi hiển thị dữ liệu.", "error");
                }
            }
             // --- POMODORO TIMER FUNCTIONS ---
            function startTimer() {
                if (isRunning) return; 
                isRunning = true;
                if(startPauseBtn) startPauseBtn.textContent = 'Tạm dừng';
                timer = setInterval(() => {
                    timeInSeconds--;
                    updateTimerDisplay();
                    if (timeInSeconds <= 0) {
                        clearInterval(timer);
                        isRunning = false;
                        if(startPauseBtn) startPauseBtn.textContent = 'Bắt đầu'; 
                        
                        if (currentMode === 'pomodoro' || currentMode === 'long-focus') {
                            state.pomodoroSessions = (state.pomodoroSessions || 0) + 1;
                            addXP(25); // NEW: Add XP
                            unlockBadge('first_pomo'); // NEW: Check for badge
                            if (state.pomodoroSessions >= 10) unlockBadge('ten_pomos'); // NEW
                            
                            // --- NEW: Link Pomodoro to Task/Project ---
                            const linkValue = pomodoroLinkSelect.value;
                            if (linkValue && linkValue !== 'none') {
                                const [type, id] = linkValue.split('-');
                                if (type === 'project') {
                                    const project = (state.projects || []).find(p => p.id == id);
                                    if (project) {
                                        project.pomodoroCount = (project.pomodoroCount || 0) + 1;
                                        console.log(`Added pomodoro to project: ${project.name}`);
                                    }
                                } else if (type === 'task') {
                                    const task = (state.tasks || []).find(t => t.id == id);
                                     if (task) {
                                        task.pomodoroCount = (task.pomodoroCount || 0) + 1;
                                         console.log(`Added pomodoro to task: ${task.text}`);
                                    }
                                }
                            }
                            // --- END NEW ---
                            
                            saveData();
                            showTemporaryMessage("Hoàn thành phiên tập trung! +25 XP", "success");
                        } else {
                            showTemporaryMessage("Đã hết giờ nghỉ!", "info");
                        }
                         
                         try {
                             const alarm = new Audio('https://interactive-examples.mdn.mozilla.net/media/cc0-audio/t-rex-roar.wav'); // Example sound
                            alarm.play().catch(e => console.warn("Audio play failed:", e)); 
                         } catch(e) { console.error("Could not create or play sound:", e); }

                         resetTimer(); 
                    }
                }, 1000);
            }
            function pauseTimer() { 
                if (!isRunning) return;
                isRunning = false; 
                if(startPauseBtn) startPauseBtn.textContent = 'Bắt đầu'; 
                clearInterval(timer); 
            }
            function resetTimer() {
                pauseTimer(); 
                let minutes;
                if(currentMode === 'pomodoro') minutes = 25; 
                else if (currentMode === 'long-focus') minutes = 50; 
                else if (currentMode === 'short') minutes = 5; 
                else if (currentMode === 'long') minutes = 15;
                else minutes = 25; 
                
                timeInSeconds = minutes * 60;
                updateTimerDisplay(); 
            }
             function switchMode(mode, minutes) {
                 if (!pomodoroBtn) return; 
                currentMode = mode;
                resetTimer(); 
                [pomodoroBtn, longFocusBtn, shortBreakBtn, longBreakBtn].forEach(btn => {
                     if(btn) btn.classList.replace('bg-indigo-600', 'bg-slate-600')
                });
                const btnMap = {pomodoro: pomodoroBtn, 'long-focus': longFocusBtn, short: shortBreakBtn, long: longBreakBtn};
                if(btnMap[mode]) btnMap[mode].classList.replace('bg-slate-600', 'bg-indigo-600');
            }


            // --- DOMContentLoaded ---
            document.addEventListener('DOMContentLoaded', () => {
                initializeUIElements(); // Assign all UI elements first
                lucide.createIcons(); // Initialize icons
                
                // --- EVENT LISTENERS ---
                if (authForm) {
                    authForm.addEventListener('submit', async (e) => {
                         e.preventDefault();
                        const email = emailInput.value;
                        const password = passwordInput.value;
                        authSubmitBtn.disabled = true;
                        authSubmitBtn.textContent = 'Đang xử lý...';
                        authError.classList.add('hidden'); 

                        if (isLoginMode) {
                            try {
                                await signInWithEmailAndPassword(auth, email, password);
                            } catch (error) {
                                 console.error("Login error:", error.code, error.message); 
                                showAuthError(error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential' ? 'Sai email hoặc mật khẩu.' : 'Đã có lỗi xảy ra khi đăng nhập.');
                                 authSubmitBtn.disabled = false; 
                                 updateAuthUI();
                            }
                        } else { 
                            const name = nameInput.value.trim();
                            if (!name) {
                                showAuthError('Vui lòng nhập họ và tên của bạn.');
                                authSubmitBtn.disabled = false;
                                updateAuthUI();
                                return;
                            }
                            try {
                                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                                const user = userCredential.user;
                                await updateProfile(user, { displayName: name });
                                const userDocRef = doc(db, "users", user.uid);
                                await setDoc(userDocRef, { ...defaultState, displayName: name }); 
                            } catch (error) {
                                 console.error("Signup error:", error.code, error.message); 
                                showAuthError(error.code === 'auth/email-already-in-use' ? 'Email này đã được sử dụng.' : 'Mật khẩu phải yếu hoặc email không hợp lệ.');
                                authSubmitBtn.disabled = false; 
                                updateAuthUI();
                            }
                        }
                        // Re-enable button ONLY if error occurred
                        setTimeout(() => { 
                             if (!auth.currentUser && authSubmitBtn) {
                                 authSubmitBtn.disabled = false;
                                 updateAuthUI(); 
                            }
                        }, 100); 
                    });
                } 

                if (logoutBtn) logoutBtn.addEventListener('click', () => signOut(auth));
                if (authToggleLink) authToggleLink.addEventListener('click', (e) => { e.preventDefault(); isLoginMode = !isLoginMode; updateAuthUI(); });

                // Mobile Sidebar Logic
                if (menuToggle) {
                    menuToggle.addEventListener('click', () => {
                         if(sidebar && sidebarOverlay){
                            sidebar.classList.remove('-translate-x-full');
                            sidebarOverlay.classList.remove('hidden');
                             requestAnimationFrame(() => { 
                                sidebarOverlay.classList.remove('opacity-0');
                             });
                        }
                    });
                }
                if (sidebarOverlay) sidebarOverlay.addEventListener('click', closeSidebar);
                if (navLinks) {
                    navLinks.forEach(link => link.addEventListener('click', (e) => {
                         e.preventDefault(); 
                        const targetId = link.getAttribute('data-target');
                        if (window.innerWidth < 1024) closeSidebar(); 

                        navLinks.forEach(nav => nav.classList.remove('active'));
                        link.classList.add('active');
                        contentSections.forEach(section => {
                            if(section) section.classList.toggle('hidden', section.id !== targetId);
                        });
                         
                         // Re-render analytics if that tab is clicked
                         if (targetId === 'analytics') {
                             renderAnalytics();
                         }
                         
                        if (mainContent) mainContent.scrollTo(0, 0); 
                    }));
                }

                // Timetable listeners
                 if (timetableBody) {
                    timetableBody.addEventListener('click', (e) => {
                        const cell = e.target.closest('td[data-id]');
                        if (cell && scheduleModal) { 
                            const cellId = cell.dataset.id;
                            modalCellId.value = cellId;
                            const [day, time] = cellId.split('-');
                            document.getElementById('modal-title').textContent = `Lịch học: ${day} lúc ${time}`;
                            if (state.schedule && state.schedule[cellId]) { 
                                subjectNameInput.value = state.schedule[cellId].subject;
                                subjectRoomInput.value = state.schedule[cellId].room || ''; 
                                deleteScheduleBtn.classList.remove('hidden');
                            } else {
                                scheduleForm.reset();
                                deleteScheduleBtn.classList.add('hidden');
                            }
                            scheduleModal.classList.remove('hidden');
                            scheduleModal.classList.add('flex');
                        }
                        const deleteBtn = e.target.closest('.delete-time-slot-btn');
                        if (deleteBtn && confirmDeleteModal) { 
                            timeToDeleteHolder = deleteBtn.dataset.time;
                            confirmDeleteMessage.textContent = `Bạn có chắc muốn xóa khung giờ ${timeToDeleteHolder} và tất cả các lớp học trong đó không?`;
                            confirmDeleteModal.classList.remove('hidden');
                            confirmDeleteModal.classList.add('flex');
                        }
                    });
                }
                if(addTimeSlotBtn && addTimeModal) addTimeSlotBtn.addEventListener('click', () => { addTimeModal.classList.remove('hidden'); addTimeModal.classList.add('flex'); });
                if(closeAddTimeModalBtn && addTimeModal) closeAddTimeModalBtn.addEventListener('click', () => { addTimeModal.classList.add('hidden'); addTimeModal.classList.remove('flex'); });
                if(addTimeForm && addTimeModal) { 
                    addTimeForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const newTime = newTimeInput.value;
                         if (newTime) {
                             if (!state.timeSlots) state.timeSlots = []; 
                            if (!state.timeSlots.includes(newTime)) {
                                state.timeSlots.push(newTime);
                                saveData(); 
                            } else { showTemporaryMessage("Khung giờ này đã tồn tại.", "warning"); }
                            addTimeForm.reset();
                            addTimeModal.classList.add('hidden');
                            addTimeModal.classList.remove('flex');
                        }
                    });
                }
                if(cancelDeleteBtn && confirmDeleteModal) cancelDeleteBtn.addEventListener('click', () => { confirmDeleteModal.classList.add('hidden'); confirmDeleteModal.classList.remove('flex'); timeToDeleteHolder = null; });
                if(confirmDeleteBtn && confirmDeleteModal) { 
                    confirmDeleteBtn.addEventListener('click', () => {
                        if(timeToDeleteHolder) {
                            state.timeSlots = (state.timeSlots || []).filter(t => t !== timeToDeleteHolder);
                            Object.keys(state.schedule || {}).forEach(key => { if (key.endsWith(`-${timeToDeleteHolder}`)) { delete state.schedule[key]; } });
                            saveData(); 
                            confirmDeleteModal.classList.add('hidden');
                            confirmDeleteModal.classList.remove('flex');
                            timeToDeleteHolder = null;
                        }
                    });
                }
                if(closeScheduleModalBtn && scheduleModal) closeScheduleModalBtn.addEventListener('click', () => { scheduleModal.classList.add('hidden'); scheduleModal.classList.remove('flex'); });
                if(scheduleForm && scheduleModal) { 
                     scheduleForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const cellId = modalCellId.value;
                        const subject = subjectNameInput.value.trim();
                        const room = subjectRoomInput.value.trim();
                        if (cellId && subject) {
                            if (!state.schedule) state.schedule = {}; 
                            state.schedule[cellId] = { subject, room };
                            saveData(); 
                            scheduleModal.classList.add('hidden');
                            scheduleModal.classList.remove('flex');
                        }
                    });
                }
                  if(deleteScheduleBtn && scheduleModal) { 
                      deleteScheduleBtn.addEventListener('click', () => {
                         const cellId = modalCellId.value;
                         if (cellId && state.schedule && state.schedule[cellId]) { 
                             delete state.schedule[cellId];
                             saveData(); 
                             scheduleModal.classList.add('hidden');
                             scheduleModal.classList.remove('flex');
                         }
                    });
                  }
                  
                 if (addGpaSubjectBtn) addGpaSubjectBtn.addEventListener('click', () => { if (!state.gpaSubjects) state.gpaSubjects = []; state.gpaSubjects.push({ id: Date.now() + Math.random(), name: '', credits: '', score: '' }); saveData(); unlockBadge('first_gpa'); });
                  if(gpaSubjectsList){ 
                        gpaSubjectsList.addEventListener('input', e => {
                            if(e.target.matches('.gpa-input')) {
                                const index = e.target.dataset.index;
                                const field = e.target.dataset.field;
                                if (!state.gpaSubjects) state.gpaSubjects = [];
                                if(!state.gpaSubjects[index]) return; 
                                state.gpaSubjects[index][field] = e.target.value;
                                calculateAndDisplayGpa(); 
                                saveData(); 
                            }
                        });
                        gpaSubjectsList.addEventListener('click', e => {
                            if(e.target.closest('.delete-gpa-subject-btn')) {
                                const index = e.target.closest('.delete-gpa-subject-btn').dataset.index;
                                if (state.gpaSubjects) state.gpaSubjects.splice(index, 1);
                                saveData(); 
                            }
                        });
                  }
                   if(taskForm) { 
                        taskForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            const text = taskInput.value.trim();
                            const projectId = taskProjectLinkSelect.value === 'null' ? null : taskProjectLinkSelect.value; // Get selected project
                            if (text) {
                                if (!state.tasks) state.tasks = [];
                                state.tasks.push({ id: Date.now() + Math.random(), text, completed: false, projectId, pomodoroCount: 0 }); // Save new fields
                                saveData(); 
                                taskForm.reset();
                                taskProjectLinkSelect.value = 'null'; // Reset select
                            }
                        });
                   }
                    if(taskList) { 
                        taskList.addEventListener('click', (e) => {
                            const target = e.target;
                            const index = target.dataset.index ?? target.closest('[data-index]')?.dataset.index; 
                            if (index === undefined) return; 

                            if (target.matches('.custom-checkbox')) {
                                if(state.tasks && state.tasks[index]) {
                                     const wasCompleted = state.tasks[index].completed;
                                     state.tasks[index].completed = target.checked;
                                     if(target.checked && !wasCompleted) { // Only add XP when checking ON
                                         addXP(10);
                                         unlockBadge('first_task');
                                     }
                                     saveData(); 
                                }
                            } else if (target.closest('.delete-task-btn')) {
                                 if(state.tasks) {
                                     state.tasks.splice(index, 1);
                                     saveData(); 
                                 }
                            }
                        });
                    }
                     if(habitForm) { 
                         habitForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            const name = habitInput.value.trim();
                            if (name) {
                                if (!state.habits) state.habits = [];
                                state.habits.push({ id: Date.now() + Math.random(), name: name, completedDates: [] });
                                saveData(); 
                                habitForm.reset();
                            }
                        });
                     }
                      if(habitList) { 
                          habitList.addEventListener('click', (e) => {
                            const target = e.target;
                             const deleteBtn = target.closest('.delete-habit-btn');
                             const habitDay = target.closest('.habit-day.today');

                            if (deleteBtn) {
                                 const index = deleteBtn.dataset.index;
                                 if(state.habits && state.habits[index]) {
                                     state.habits.splice(index, 1);
                                     saveData(); 
                                 }
                            } else if (habitDay) {
                                const dateStr = habitDay.dataset.date;
                                const habitIndex = habitDay.dataset.habitIndex;
                                if(state.habits && state.habits[habitIndex]) {
                                    if (!state.habits[habitIndex].completedDates) state.habits[habitIndex].completedDates = [];
                                    const dateIndex = state.habits[habitIndex].completedDates.indexOf(dateStr);
                                    if (dateIndex > -1) {
                                        state.habits[habitIndex].completedDates.splice(dateIndex, 1); // Un-checking
                                    } else {
                                        state.habits[habitIndex].completedDates.push(dateStr); // Checking
                                        addXP(5); // Add XP for completing
                                        // Check for 3-day streak
                                        let streak = 0;
                                        for(let i = 0; i < 3; i++) {
                                             const d = new Date(dateStr);
                                             d.setDate(d.getDate() - i);
                                             if(state.habits[habitIndex].completedDates.includes(d.toISOString().split('T')[0])) {
                                                 streak++;
                                             }
                                        }
                                        if(streak >= 3) unlockBadge('first_habit');
                                    }
                                    saveData(); 
                                }
                            }
                        });
                      }
                      if(goalForm) { 
                          goalForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            const text = goalInput.value.trim();
                            if (text) {
                                if (!state.goals) state.goals = [];
                                state.goals.push({ id: Date.now() + Math.random(), text, completed: false });
                                saveData(); 
                                goalForm.reset();
                            }
                        });
                      }
                      if(goalList) { 
                          goalList.addEventListener('click', (e) => {
                            const target = e.target;
                             const index = target.dataset.index ?? target.closest('[data-index]')?.dataset.index; 
                             if (index === undefined) return;

                            if (target.matches('.custom-checkbox')) {
                                if(state.goals && state.goals[index]) {
                                     state.goals[index].completed = target.checked;
                                      saveData(); 
                                }
                            } else if (target.closest('.delete-goal-btn')) {
                                if(state.goals) {
                                     state.goals.splice(index, 1);
                                      saveData(); 
                                }
                            }
                        });
                      }
                      if(projectForm) { 
                          projectForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            const name = projectInput.value.trim();
                            if (name) {
                                if (!state.projects) state.projects = [];
                                state.projects.push({ id: Date.now() + Math.random(), name: name, tasks: [], pomodoroCount: 0 }); // Add pomodoroCount
                                saveData(); 
                                unlockBadge('first_project');
                                projectForm.reset();
                            }
                        });
                      }
                      if(projectList){ 
                            projectList.addEventListener('click', (e) => { 
                                const target = e.target;
                                let dataChanged = false;
                                const deleteBtn = target.closest('.delete-project-btn');
                                const checkbox = target.closest('.project-task .custom-checkbox');
                                const deleteTaskBtn = target.closest('.delete-project-task-btn');

                                if (deleteBtn) {
                                    const projectId = parseInt(deleteBtn.dataset.projectId, 10);
                                    state.projects = (state.projects || []).filter(p => p.id !== projectId);
                                    // Also remove tasks associated with this project
                                    state.tasks = (state.tasks || []).filter(t => t.projectId != projectId);
                                    dataChanged = true;
                                } else if (checkbox) {
                                    const projectId = parseInt(checkbox.dataset.projectId, 10);
                                    const taskIndex = parseInt(checkbox.dataset.taskIndex, 10);
                                    const project = (state.projects || []).find(p => p.id === projectId);
                                    if (project && project.tasks && project.tasks[taskIndex]) {
                                        const wasCompleted = project.tasks[taskIndex].completed;
                                        project.tasks[taskIndex].completed = checkbox.checked;
                                        if(checkbox.checked && !wasCompleted) { // Only add XP when checking ON
                                            addXP(15);
                                        }
                                        dataChanged = true;
                                    }
                                } else if (deleteTaskBtn) {
                                    const projectId = parseInt(deleteTaskBtn.dataset.projectId, 10);
                                    const taskIndex = parseInt(deleteTaskBtn.dataset.taskIndex, 10);
                                    const project = (state.projects || []).find(p => p.id === projectId);
                                    if (project && project.tasks) {
                                        project.tasks.splice(taskIndex, 1);
                                        dataChanged = true;
                                    }
                                }
                                if (dataChanged) { saveData(); } 
                             });
                            projectList.addEventListener('submit', (e) => { 
                                e.preventDefault();
                                if(e.target.classList.contains('add-project-task-form')) {
                                    const form = e.target;
                                    const input = form.querySelector('input');
                                    const text = input.value.trim();
                                    if(text) {
                                        const projectId = parseInt(input.dataset.projectId, 10);
                                        const project = (state.projects || []).find(p => p.id === projectId);
                                        if (project) {
                                            if (!project.tasks) project.tasks = [];
                                            project.tasks.push({ id: Date.now() + Math.random(), text: text, completed: false }); // Add unique ID
                                            saveData(); 
                                            form.reset();
                                        }
                                    }
                                }
                             });
                        }
                         if(eventForm) { 
                             eventForm.addEventListener('submit', e => {
                                e.preventDefault();
                                const name = eventInput.value.trim();
                                const date = eventDateInput.value;
                                if(name && date) {
                                     if (!state.events) state.events = [];
                                    state.events.push({ id: Date.now(), name, date });
                                    saveData(); 
                                    eventForm.reset();
                                }
                            });
                         }
                          if(eventList) { 
                               eventList.addEventListener('click', e => {
                                if(e.target.closest('.delete-event-btn')) {
                                    const eventId = parseInt(e.target.closest('.delete-event-btn').dataset.eventId);
                                    if(state.events) state.events = state.events.filter(ev => ev.id !== eventId);
                                    saveData(); 
                                }
                            });
                          }
                         if (startPauseBtn) startPauseBtn.addEventListener('click', () => isRunning ? pauseTimer() : startTimer());
                         if (resetBtn) resetBtn.addEventListener('click', resetTimer);
                         if (pomodoroBtn) pomodoroBtn.addEventListener('click', () => switchMode('pomodoro', 25));
                         if (longFocusBtn) longFocusBtn.addEventListener('click', () => switchMode('long-focus', 50));
                         if (shortBreakBtn) shortBreakBtn.addEventListener('click', () => switchMode('short', 5));
                         if (longBreakBtn) longBreakBtn.addEventListener('click', () => switchMode('long', 15));
                         if (notesTextarea) notesTextarea.addEventListener('input', () => { state.notes = notesTextarea.value; saveData(); });
                         if (resourceForm) { 
                            resourceForm.addEventListener('submit', (e) => {
                                e.preventDefault();
                                const name = resourceNameInput.value.trim();
                                const url = resourceUrlInput.value.trim();
                                const subjectName = resourceSubjectLinkSelect.value === 'null' ? null : resourceSubjectLinkSelect.value;
                                
                                 let isValidUrl = false;
                                 try { new URL(url); isValidUrl = url.startsWith('http://') || url.startsWith('https://'); } catch (_) { isValidUrl = false; }
                                 
                                 resourceUrlInput.classList.remove('border-red-500'); 
                                 resourceNameInput.classList.remove('border-red-500'); 
                                 
                                if (name && isValidUrl) {
                                    if (!state.resources) state.resources = [];
                                    state.resources.push({id: Date.now() + Math.random(), name, url, subjectName}); // Save new fields
                                    saveData(); 
                                    e.target.reset();
                                    resourceSubjectLinkSelect.value = 'null'; // Reset select
                                } else {
                                     if (!name) resourceNameInput.classList.add('border-red-500');
                                     if (!isValidUrl) {
                                         resourceUrlInput.classList.add('border-red-500'); 
                                         showTemporaryMessage("URL không hợp lệ. Phải bắt đầu bằng http:// hoặc https://", "error");
                                     } else {
                                          showTemporaryMessage("Vui lòng nhập tên tài nguyên.", "error"); 
                                     }
                                }
                            });
                          }
                           if (resourceList) { 
                            resourceList.addEventListener('click', (e) => {
                                if (e.target.closest('.delete-resource-btn')) {
                                    const index = e.target.closest('.delete-resource-btn').dataset.index;
                                    if (state.resources && state.resources[index] !== undefined) {
                                         state.resources.splice(index, 1);
                                         saveData(); 
                                    }
                                }
                            });
                          }
                           if (musicSelection) { 
                                musicSelection.addEventListener('click', e => {
                                    const deleteBtn = e.target.closest('.delete-music-btn');
                                    if (deleteBtn) {
                                        e.stopPropagation(); 
                                        const videoIdToDelete = deleteBtn.dataset.videoId;
                                        if(state.userMusic) state.userMusic = state.userMusic.filter(music => music.videoId !== videoIdToDelete);
                                        if (state.currentMusicId === videoIdToDelete) {
                                            state.currentMusicId = defaultMusicOptionsGlobal[0].videoId; 
                                        }
                                        saveData(); 
                                        renderMusicOptions(); // Re-render after deleting
                                        return; 
                                    }
                                    const optionBtn = e.target.closest('.music-option-btn');
                                    if (optionBtn) {
                                        state.currentMusicId = optionBtn.dataset.videoId;
                                        if(musicPlayer) musicPlayer.src = `https://www.youtube.com/embed/${state.currentMusicId}?autoplay=1`;
                                        saveData(); 
                                        renderMusicOptions(); 
                                    }
                                });
                            }
                           if (addMusicForm) { 
                              addMusicForm.addEventListener('submit', e => {
                                    e.preventDefault();
                                    const name = musicNameInput.value.trim();
                                    const url = musicUrlInput.value.trim();
                                    const videoId = getYoutubeVideoId(url);
                                    
                                    musicUrlInput.classList.remove('border-red-500', 'placeholder-red-400');
                                     musicNameInput.classList.remove('border-red-500'); 
                                    musicUrlInput.placeholder = "Dán link YouTube vào đây";

                                    if (name && videoId) {
                                        const allMusic = [...defaultMusicOptionsGlobal, ...(state.userMusic || [])];
                                        if (allMusic.some(option => option.videoId === videoId)) {
                                            musicUrlInput.value = ""; 
                                            musicUrlInput.placeholder = "Link này đã tồn tại!";
                                            musicUrlInput.classList.add('border-red-500','placeholder-red-400');
                                            setTimeout(() => { 
                                                 musicUrlInput.classList.remove('border-red-500','placeholder-red-400');
                                                 musicUrlInput.placeholder = "Dán link YouTube vào đây";
                                            }, 2500);
                                            return;
                                        }
                                        if (!state.userMusic) state.userMusic = [];
                                        state.userMusic.push({ name, videoId, icon: 'list-music', isCustom: true });
                                        saveData(); 
                                        addMusicForm.reset();
                                    } else {
                                        if (!name) musicNameInput.classList.add('border-red-500');
                                        if (!videoId) {
                                            musicUrlInput.classList.add('border-red-500', 'placeholder-red-400');
                                            musicUrlInput.placeholder = "Link YouTube không hợp lệ!";
                                        }
                                         setTimeout(() => {
                                            musicUrlInput.classList.remove('border-red-500', 'placeholder-red-400');
                                             musicNameInput.classList.remove('border-red-500');
                                            musicUrlInput.placeholder = "Dán link YouTube vào đây";
                                        }, 2500);
                                    }
                                });
                            }


                // --- INITIAL SETUP ---
                setInterval(updateCountdowns, 1000); // Keep countdowns running
                
                isLoginMode = true; // Set initial auth mode 
                updateAuthUI(); 

                updateTimerDisplay(); // Initialize Pomodoro timer display
                 
                 if (currentDateEl) {
                     currentDateEl.textContent = new Date().toLocaleDateString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                 }
          }); // End DOMContentLoaded listener


        } catch (error) {
             console.error("Firebase initialization failed:", error);
             document.body.innerHTML = `<div style="padding: 2rem; text-align: center; color: #cbd5e1; font-family: Inter, sans-serif;"><h1>Lỗi Kết Nối</h1><p>Không thể khởi tạo ứng dụng. Vui lòng kiểm tra lại thông tin <strong>firebaseConfig</strong> của bạn.</p><p style="font-size: 0.8rem; color: #64748b;">Chi tiết lỗi: ${error.message}</p></div>`;
        }

    </script>
</body>
</html>

